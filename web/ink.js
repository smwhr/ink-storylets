!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).inkjs={})}(this,function(a){"use strict";function g(t){return(g="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function d(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function o(t,e,n){return e&&i(t.prototype,e),n&&i(t,n),t}function u(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&s(t,e)}function r(t){return(r=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function s(t,e){return(s=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function l(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(t){return!1}}function h(t,e,n){return(h=l()?Reflect.construct:function(t,e,n){var i=[null];i.push.apply(i,e);i=new(Function.bind.apply(t,i));return n&&s(i,n.prototype),i}).apply(null,arguments)}function c(t){var i="function"==typeof Map?new Map:void 0;return(c=function(t){if(null===t||(e=t,-1===Function.toString.call(e).indexOf("[native code]")))return t;var e;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==i){if(i.has(t))return i.get(t);i.set(t,n)}function n(){return h(t,arguments,r(this).constructor)}return n.prototype=Object.create(t.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),s(n,t)})(t)}function f(t,e){return!e||"object"!=typeof e&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function v(n){var i=l();return function(){var t,e=r(n);return f(this,i?(t=r(this).constructor,Reflect.construct(e,arguments,t)):e.apply(this,arguments))}}function S(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var n=t&&("undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"]);if(null!=n){var i,r,a=[],s=!0,o=!1;try{for(n=n.call(t);!(s=(i=n.next()).done)&&(a.push(i.value),!e||a.length!==e);s=!0);}catch(t){o=!0,r=t}finally{try{s||null==n.return||n.return()}finally{if(o)throw r}}return a}}(t,e)||y(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function p(t){return function(t){if(Array.isArray(t))return m(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||y(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function y(t,e){if(t){if("string"==typeof t)return m(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Map"===(n="Object"===n&&t.constructor?t.constructor.name:n)||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?m(t,e):void 0}}function m(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=new Array(e);n<e;n++)i[n]=t[n];return i}function W(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=y(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var i=0,e=function(){};return{s:e,n:function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}},e:function(t){throw t},f:e}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,a=!0,s=!1;return{s:function(){n=n.call(t)},n:function(){var t=n.next();return a=t.done,t},e:function(t){s=!0,r=t},f:function(){try{a||null==n.return||n.return()}finally{if(s)throw r}}}}var t,k,C=function(){function s(){var t,e;d(this,s),this._components=[],this._componentsString=null,this._isRelative=!1,"string"==typeof arguments[0]?this.componentsString=arguments[0]:arguments[0]instanceof s.Component&&arguments[1]instanceof s?(t=arguments[0],e=arguments[1],this._components.push(t),this._components=this._components.concat(e._components)):arguments[0]instanceof Array&&(t=arguments[0],e=!!arguments[1],this._components=this._components.concat(t),this._isRelative=e)}return o(s,[{key:"isRelative",get:function(){return this._isRelative}},{key:"componentCount",get:function(){return this._components.length}},{key:"head",get:function(){return 0<this._components.length?this._components[0]:null}},{key:"tail",get:function(){return 2<=this._components.length?new s(this._components.slice(1,this._components.length)):s.self}},{key:"length",get:function(){return this._components.length}},{key:"lastComponent",get:function(){var t=this._components.length-1;return 0<=t?this._components[t]:null}},{key:"containsNamedComponent",get:function(){for(var t=0,e=this._components.length;t<e;t++)if(!this._components[t].isIndex)return!0;return!1}},{key:"GetComponent",value:function(t){return this._components[t]}},{key:"PathByAppendingPath",value:function(t){for(var e=new s,n=0,i=0;i<t._components.length&&t._components[i].isParent;++i)n++;for(var r=0;r<this._components.length-n;++r)e._components.push(this._components[r]);for(var a=n;a<t._components.length;++a)e._components.push(t._components[a]);return e}},{key:"componentsString",get:function(){return null==this._componentsString&&(this._componentsString=this._components.join("."),this.isRelative&&(this._componentsString="."+this._componentsString)),this._componentsString},set:function(t){if(this._components.length=0,this._componentsString=t,null!=this._componentsString&&""!=this._componentsString){"."==this._componentsString[0]&&(this._isRelative=!0,this._componentsString=this._componentsString.substring(1));var e,n=W(this._componentsString.split("."));try{for(n.s();!(e=n.n()).done;){var i=e.value;/^(\-|\+)?([0-9]+|Infinity)$/.test(i)?this._components.push(new s.Component(parseInt(i))):this._components.push(new s.Component(i))}}catch(t){n.e(t)}finally{n.f()}}}},{key:"toString",value:function(){return this.componentsString}},{key:"Equals",value:function(t){if(null==t)return!1;if(t._components.length!=this._components.length)return!1;if(t.isRelative!=this.isRelative)return!1;for(var e=0,n=t._components.length;e<n;e++)if(!t._components[e].Equals(this._components[e]))return!1;return!0}},{key:"PathByAppendingComponent",value:function(t){var e,n=new s;return(e=n._components).push.apply(e,p(this._components)),n._components.push(t),n}}],[{key:"self",get:function(){var t=new s;return t._isRelative=!0,t}}]),s}();function b(t,e){if(!t)throw void 0!==e&&console.warn(e),console.trace&&console.trace(),new Error("")}function V(t,e){return t instanceof e?t:null}function L(t,e){if(t instanceof e)return t;throw new Error("".concat(t," is not of type ").concat(e))}function _(t){return t.hasValidName&&t.name?t:null}function e(t){return void 0===t?null:t}function w(t){return"object"===g(t)&&"function"==typeof t.Equals}C.parentId="^",(t=C=C||{}).Component=function(){function e(t){d(this,e),this.index=-1,this.name=null,"string"==typeof t?this.name=t:this.index=t}return o(e,[{key:"isIndex",get:function(){return 0<=this.index}},{key:"isParent",get:function(){return this.name==t.parentId}},{key:"toString",value:function(){return this.isIndex?this.index.toString():this.name}},{key:"Equals",value:function(t){return null!=t&&t.isIndex==this.isIndex&&(this.isIndex?this.index==t.index:this.name==t.name)}}],[{key:"ToParent",value:function(){return new e(t.parentId)}}]),e}(),(pt=k=k||{}).AssertType=function(t,e,n){b(t instanceof e,n)},pt.Assert=b;var n=function(){u(e,c(Error));var t=v(e);function e(){return d(this,e),t.apply(this,arguments)}return e}();function R(t){throw new n("".concat(t," is null or undefined"))}var T=function(){function t(){d(this,t),this.parent=null,this._debugMetadata=null,this._path=null}return o(t,[{key:"debugMetadata",get:function(){return null===this._debugMetadata&&this.parent?this.parent.debugMetadata:this._debugMetadata},set:function(t){this._debugMetadata=t}},{key:"ownDebugMetadata",get:function(){return this._debugMetadata}},{key:"DebugLineNumberOfPath",value:function(t){if(null===t)return null;var e=this.rootContentContainer;if(e){t=e.ContentAtPath(t).obj;if(t){t=t.debugMetadata;if(null!==t)return t.startLineNumber}}return null}},{key:"path",get:function(){if(null==this._path)if(null==this.parent)this._path=new C;else{for(var t=[],e=this,n=V(e.parent,z);null!==n;){var i=_(e);null!=i&&i.hasValidName?t.unshift(new C.Component(i.name)):t.unshift(new C.Component(n.content.indexOf(e))),n=V((e=n).parent,z)}this._path=new C(t)}return this._path}},{key:"ResolvePath",value:function(t){if(null===t)return R("path");if(t.isRelative){var e=V(this,z);return null===e&&(k.Assert(null!==this.parent,"Can't resolve relative path because we don't have a parent"),e=V(this.parent,z),k.Assert(null!==e,"Expected parent to be a container"),k.Assert(t.GetComponent(0).isParent),t=t.tail),null===e?R("nearestContainer"):e.ContentAtPath(t)}e=this.rootContentContainer;return null===e?R("contentContainer"):e.ContentAtPath(t)}},{key:"ConvertPathToRelative",value:function(t){for(var e=this.path,n=Math.min(t.length,e.length),i=-1,r=0;r<n;++r){var a=e.GetComponent(r),s=t.GetComponent(r);if(!a.Equals(s))break;i=r}if(-1==i)return t;for(var o=e.componentCount-1-i,u=[],l=0;l<o;++l)u.push(C.Component.ToParent());for(var h=i+1;h<t.componentCount;++h)u.push(t.GetComponent(h));return new C(u,!0)}},{key:"CompactPathString",value:function(t){var e=null,n=null;return e=t.isRelative?(n=t.componentsString,this.path.PathByAppendingPath(t).componentsString):(n=this.ConvertPathToRelative(t).componentsString,t.componentsString),n.length<e.length?n:e}},{key:"rootContentContainer",get:function(){for(var t=this;t.parent;)t=t.parent;return V(t,z)}},{key:"Copy",value:function(){throw Error("Not Implemented: Doesn't support copying")}},{key:"SetChild",value:function(t,e,n){t[e]&&(t[e]=null),t[e]=n,t[e]&&(t[e].parent=this)}}]),t}(),j=function(){function e(t){d(this,e),t=void 0!==t?t.toString():"",this.string=t}return o(e,[{key:"Length",get:function(){return this.string.length}},{key:"Append",value:function(t){null!==t&&(this.string+=t)}},{key:"AppendLine",value:function(t){void 0!==t&&this.Append(t),this.string+="\n"}},{key:"AppendFormat",value:function(t){for(var e=arguments.length,n=new Array(1<e?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];this.string+=t.replace(/{(\d+)}/g,function(t,e){return void 0!==n[e]?n[e]:t})}},{key:"toString",value:function(){return this.string}}]),e}(),D=function(){function n(){var t,e;d(this,n),this.originName=null,this.itemName=null,void 0!==arguments[1]?(t=arguments[0],e=arguments[1],this.originName=t,this.itemName=e):arguments[0]&&(e=arguments[0].toString().split("."),this.originName=e[0],this.itemName=e[1])}return o(n,[{key:"isNull",get:function(){return null==this.originName&&null==this.itemName}},{key:"fullName",get:function(){return(null!==this.originName?this.originName:"?")+"."+this.itemName}},{key:"toString",value:function(){return this.fullName}},{key:"Equals",value:function(t){return t instanceof n&&(t.itemName==this.itemName&&t.originName==this.originName)}},{key:"copy",value:function(){return new n(this.originName,this.itemName)}},{key:"serialized",value:function(){return JSON.stringify({originName:this.originName,itemName:this.itemName})}}],[{key:"Null",get:function(){return new n(null,null)}},{key:"fromSerializedKey",value:function(t){t=JSON.parse(t);if(!n.isLikeInkListItem(t))return n.Null;return new n(t.originName,t.itemName)}},{key:"isLikeInkListItem",value:function(t){return"object"===g(t)&&(!(!t.hasOwnProperty("originName")||!t.hasOwnProperty("itemName"))&&(("string"==typeof t.originName||null===typeof t.originName)&&("string"==typeof t.itemName||null===typeof t.itemName)))}}]),n}(),B=function(){u(l,c(Map));var i=v(l);function l(){var t=arguments;if(d(this,l),(t=i.call(this,t[0]instanceof l?t[0]:[])).origins=null,t._originNames=[],arguments[0]instanceof l){var e=arguments[0];t._originNames=e.originNames,null!==e.origins&&(t.origins=e.origins.slice())}else if("string"==typeof arguments[0]){var e=arguments[0],n=arguments[1];if(t.SetInitialOriginName(e),null===n.listDefinitions)return f(t,R("originStory.listDefinitions"));var n=n.listDefinitions.TryListGetDefinition(e,null);if(!n.exists)throw new Error("InkList origin could not be found in story when constructing new list: "+e);if(null===n.result)return f(t,R("def.result"));t.origins=[n.result]}else"object"===g(arguments[0])&&arguments[0].hasOwnProperty("Key")&&arguments[0].hasOwnProperty("Value")&&t.Add((n=arguments[0]).Key,n.Value);return t}return o(l,[{key:"AddItem",value:function(t){if(t instanceof D){var e=t;if(null!=e.originName){if(null===this.origins)return R("this.origins");var n,i=W(this.origins);try{for(i.s();!(n=i.n()).done;){var r=n.value;if(r.name==e.originName){var a=r.TryGetValueForItem(e,0);if(a.exists)return void this.Add(e,a.result);throw new Error("Could not add the item "+e+" to this list because it doesn't exist in the original list definition in ink.")}}}catch(t){i.e(t)}finally{i.f()}throw new Error("Failed to add item to list because the item was from a new list definition that wasn't previously known to this list. Only items from previously known lists can be used, so that the int value can be found.")}this.AddItem(e.itemName)}else{var s=t,o=null;if(null===this.origins)return R("this.origins");var u,l=W(this.origins);try{for(l.s();!(u=l.n()).done;){var h=u.value;if(null===s)return R("itemName");if(h.ContainsItemWithName(s)){if(null!=o)throw new Error("Could not add the item "+s+" to this list because it could come from either "+h.name+" or "+o.name);o=h}}}catch(t){l.e(t)}finally{l.f()}if(null==o)throw new Error("Could not add the item "+s+" to this list because it isn't known to any list definitions previously associated with this list.");var c=new D(o.name,s),t=o.ValueForItem(c);this.Add(c,t)}}},{key:"ContainsItemNamed",value:function(t){var e,n=W(this);try{for(n.s();!(e=n.n()).done;){var i=S(e.value,1)[0];if(D.fromSerializedKey(i).itemName==t)return!0}}catch(t){n.e(t)}finally{n.f()}return!1}},{key:"ContainsKey",value:function(t){return this.has(t.serialized())}},{key:"Add",value:function(t,e){var n=t.serialized();if(this.has(n))throw new Error("The Map already contains an entry for ".concat(t));this.set(n,e)}},{key:"Remove",value:function(t){return this.delete(t.serialized())}},{key:"Count",get:function(){return this.size}},{key:"originOfMaxItem",get:function(){if(null==this.origins)return null;var e=this.maxItem.Key.originName,n=null;return this.origins.every(function(t){return t.name!=e||(n=t,!1)}),n}},{key:"originNames",get:function(){if(0<this.Count){null==this._originNames&&0<this.Count?this._originNames=[]:(this._originNames||(this._originNames=[]),this._originNames.length=0);var t,e=W(this);try{for(e.s();!(t=e.n()).done;){var n=S(t.value,1)[0],i=D.fromSerializedKey(n);if(null===i.originName)return R("item.originName");this._originNames.push(i.originName)}}catch(t){e.e(t)}finally{e.f()}}return this._originNames}},{key:"SetInitialOriginName",value:function(t){this._originNames=[t]}},{key:"SetInitialOriginNames",value:function(t){this._originNames=null==t?null:t.slice()}},{key:"maxItem",get:function(){var t,e={Key:D.Null,Value:0},n=W(this);try{for(n.s();!(t=n.n()).done;){var i=S(t.value,2),r=i[0],a=i[1],s=D.fromSerializedKey(r);(e.Key.isNull||a>e.Value)&&(e={Key:s,Value:a})}}catch(t){n.e(t)}finally{n.f()}return e}},{key:"minItem",get:function(){var t,e={Key:D.Null,Value:0},n=W(this);try{for(n.s();!(t=n.n()).done;){var i=S(t.value,2),r=i[0],a=i[1],s=D.fromSerializedKey(r);(e.Key.isNull||a<e.Value)&&(e={Key:s,Value:a})}}catch(t){n.e(t)}finally{n.f()}return e}},{key:"inverse",get:function(){var t=new l;if(null!=this.origins){var e,n=W(this.origins);try{for(n.s();!(e=n.n()).done;){var i,r=W(e.value.items);try{for(r.s();!(i=r.n()).done;){var a=S(i.value,2),s=a[0],o=a[1],u=D.fromSerializedKey(s);this.ContainsKey(u)||t.Add(u,o)}}catch(t){r.e(t)}finally{r.f()}}}catch(t){n.e(t)}finally{n.f()}}return t}},{key:"all",get:function(){var t=new l;if(null!=this.origins){var e,n=W(this.origins);try{for(n.s();!(e=n.n()).done;){var i,r=W(e.value.items);try{for(r.s();!(i=r.n()).done;){var a=S(i.value,2),s=a[0],o=a[1],u=D.fromSerializedKey(s);t.set(u.serialized(),o)}}catch(t){r.e(t)}finally{r.f()}}}catch(t){n.e(t)}finally{n.f()}}return t}},{key:"Union",value:function(t){var e,n=new l(this),i=W(t);try{for(i.s();!(e=i.n()).done;){var r=S(e.value,2),a=r[0],s=r[1];n.set(a,s)}}catch(t){i.e(t)}finally{i.f()}return n}},{key:"Intersect",value:function(t){var e,n=new l,i=W(this);try{for(i.s();!(e=i.n()).done;){var r=S(e.value,2),a=r[0],s=r[1];t.has(a)&&n.set(a,s)}}catch(t){i.e(t)}finally{i.f()}return n}},{key:"Without",value:function(t){var e,n=new l(this),i=W(t);try{for(i.s();!(e=i.n()).done;){var r=S(e.value,1)[0];n.delete(r)}}catch(t){i.e(t)}finally{i.f()}return n}},{key:"Contains",value:function(t){var e,n=W(t);try{for(n.s();!(e=n.n()).done;){var i=S(e.value,1)[0];if(!this.has(i))return!1}}catch(t){n.e(t)}finally{n.f()}return!0}},{key:"GreaterThan",value:function(t){return 0!=this.Count&&(0==t.Count||this.minItem.Value>t.maxItem.Value)}},{key:"GreaterThanOrEquals",value:function(t){return 0!=this.Count&&(0==t.Count||this.minItem.Value>=t.minItem.Value&&this.maxItem.Value>=t.maxItem.Value)}},{key:"LessThan",value:function(t){return 0!=t.Count&&(0==this.Count||this.maxItem.Value<t.minItem.Value)}},{key:"LessThanOrEquals",value:function(t){return 0!=t.Count&&(0==this.Count||this.maxItem.Value<=t.maxItem.Value&&this.minItem.Value<=t.minItem.Value)}},{key:"MaxAsList",value:function(){return 0<this.Count?new l(this.maxItem):new l}},{key:"MinAsList",value:function(){return 0<this.Count?new l(this.minItem):new l}},{key:"ListWithSubRange",value:function(t,e){if(0==this.Count)return new l;var n=this.orderedItems,i=0,r=Number.MAX_SAFE_INTEGER;Number.isInteger(t)?i=t:t instanceof l&&0<t.Count&&(i=t.minItem.Value),Number.isInteger(e)?r=e:t instanceof l&&0<t.Count&&(r=e.maxItem.Value);var a=new l;a.SetInitialOriginNames(this.originNames);var s,o=W(n);try{for(o.s();!(s=o.n()).done;){var u=s.value;u.Value>=i&&u.Value<=r&&a.Add(u.Key,u.Value)}}catch(t){o.e(t)}finally{o.f()}return a}},{key:"Equals",value:function(t){if(t instanceof l==!1)return!1;if(t.Count!=this.Count)return!1;var e,n=W(this);try{for(n.s();!(e=n.n()).done;){var i=S(e.value,1)[0];if(!t.has(i))return!1}}catch(t){n.e(t)}finally{n.f()}return!0}},{key:"orderedItems",get:function(){var t,e=new Array,n=W(this);try{for(n.s();!(t=n.n()).done;){var i=S(t.value,2),r=i[0],a=i[1],s=D.fromSerializedKey(r);e.push({Key:s,Value:a})}}catch(t){n.e(t)}finally{n.f()}return e.sort(function(t,e){return null===t.Key.originName?R("x.Key.originName"):null===e.Key.originName?R("y.Key.originName"):t.Value==e.Value?t.Key.originName.localeCompare(e.Key.originName):t.Value<e.Value?-1:t.Value>e.Value?1:0}),e}},{key:"toString",value:function(){for(var t=this.orderedItems,e=new j,n=0;n<t.length;n++){0<n&&e.Append(", ");var i=t[n].Key;if(null===i.itemName)return R("item.itemName");e.Append(i.itemName)}return e.toString()}},{key:"valueOf",value:function(){return NaN}}],[{key:"FromString",value:function(t,e){e=null===(e=e.listDefinitions)||void 0===e?void 0:e.FindSingleItemListWithName(t);if(e)return null===e.value?R("listValue.value"):new l(e.value);throw new Error("Could not find the InkListItem from the string '"+t+"' to create an InkList because it doesn't exist in the original list definition in ink.")}}]),l}(),G=function(){u(i,c(Error));var n=v(i);function i(t){var e;return d(this,i),(e=n.call(this,t)).useEndLineNumber=!1,e.message=t,e.name="StoryException",e}return i}();function E(t,e,n){if(null===t)return{result:n,exists:!1};e=t.get(e);return void 0===e?{result:n,exists:!1}:{result:e,exists:!0}}var P,O=function(){u(e,T);var t=v(e);function e(){return d(this,e),t.apply(this,arguments)}return o(e,[{key:"Copy",value:function(){return L(e.Create(this),T)}},{key:"BadCastException",value:function(t){return new G("Can't cast "+this.valueObject+" from "+this.valueType+" to "+t)}}],[{key:"Create",value:function(t,e){if(e){if(e===P.Int&&Number.isInteger(Number(t)))return new J(Number(t));if(e===P.Float&&!isNaN(t))return new A(Number(t))}return"boolean"==typeof t?new N(Boolean(t)):"string"==typeof t?new U(String(t)):Number.isInteger(Number(t))?new J(Number(t)):isNaN(t)?t instanceof C?new q(L(t,C)):t instanceof B?new K(L(t,B)):null:new A(Number(t))}}]),e}(),M=function(){u(i,O);var n=v(i);function i(t){var e;return d(this,i),(e=n.call(this)).value=t,e}return o(i,[{key:"valueObject",get:function(){return this.value}},{key:"toString",value:function(){return null===this.value?R("Value.value"):this.value.toString()}}]),i}(),N=function(){u(n,M);var e=v(n);function n(t){return d(this,n),e.call(this,t||!1)}return o(n,[{key:"isTruthy",get:function(){return Boolean(this.value)}},{key:"valueType",get:function(){return P.Bool}},{key:"Cast",value:function(t){if(null===this.value)return R("Value.value");if(t==this.valueType)return this;if(t==P.Int)return new J(this.value?1:0);if(t==P.Float)return new A(this.value?1:0);if(t==P.String)return new U(this.value?"true":"false");throw this.BadCastException(t)}},{key:"toString",value:function(){return this.value?"true":"false"}}]),n}(),J=function(){u(n,M);var e=v(n);function n(t){return d(this,n),e.call(this,t||0)}return o(n,[{key:"isTruthy",get:function(){return 0!=this.value}},{key:"valueType",get:function(){return P.Int}},{key:"Cast",value:function(t){if(null===this.value)return R("Value.value");if(t==this.valueType)return this;if(t==P.Bool)return new N(0!==this.value);if(t==P.Float)return new A(this.value);if(t==P.String)return new U(""+this.value);throw this.BadCastException(t)}}]),n}(),A=function(){u(n,M);var e=v(n);function n(t){return d(this,n),e.call(this,t||0)}return o(n,[{key:"isTruthy",get:function(){return 0!=this.value}},{key:"valueType",get:function(){return P.Float}},{key:"Cast",value:function(t){if(null===this.value)return R("Value.value");if(t==this.valueType)return this;if(t==P.Bool)return new N(0!==this.value);if(t==P.Int)return new J(this.value);if(t==P.String)return new U(""+this.value);throw this.BadCastException(t)}}]),n}(),U=function(){u(i,M);var n=v(i);function i(t){var e;return d(this,i),(e=n.call(this,t||""))._isNewline="\n"==e.value,e._isInlineWhitespace=!0,null===e.value?f(e,R("Value.value")):(0<e.value.length&&e.value.split("").every(function(t){return" "==t||"\t"==t||(e._isInlineWhitespace=!1)}),e)}return o(i,[{key:"valueType",get:function(){return P.String}},{key:"isTruthy",get:function(){return null===this.value?R("Value.value"):0<this.value.length}},{key:"isNewline",get:function(){return this._isNewline}},{key:"isInlineWhitespace",get:function(){return this._isInlineWhitespace}},{key:"isNonWhitespace",get:function(){return!this.isNewline&&!this.isInlineWhitespace}},{key:"Cast",value:function(t){if(t==this.valueType)return this;if(t==P.Int){var e=function(t,e){return e=1<arguments.length&&void 0!==e?e:0,t=parseInt(t),Number.isNaN(t)?{result:e,exists:!1}:{result:t,exists:!0}}(this.value);if(e.exists)return new J(e.result);throw this.BadCastException(t)}if(t!=P.Float)throw this.BadCastException(t);e=function(t,e){return e=1<arguments.length&&void 0!==e?e:0,t=parseFloat(t),Number.isNaN(t)?{result:e,exists:!1}:{result:t,exists:!0}}(this.value);if(e.exists)return new A(e.result);throw this.BadCastException(t)}}]),i}(),q=function(){u(n,M);var e=v(n);function n(t){return d(this,n),e.call(this,t)}return o(n,[{key:"valueType",get:function(){return P.DivertTarget}},{key:"targetPath",get:function(){return null===this.value?R("Value.value"):this.value},set:function(t){this.value=t}},{key:"isTruthy",get:function(){throw new Error("Shouldn't be checking the truthiness of a divert target")}},{key:"Cast",value:function(t){if(t==this.valueType)return this;throw this.BadCastException(t)}},{key:"toString",value:function(){return"DivertTargetValue("+this.targetPath+")"}}]),n}(),I=function(){u(i,M);var n=v(i);function i(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:-1;return d(this,i),(t=n.call(this,t))._contextIndex=e,t}return o(i,[{key:"contextIndex",get:function(){return this._contextIndex},set:function(t){this._contextIndex=t}},{key:"variableName",get:function(){return null===this.value?R("Value.value"):this.value},set:function(t){this.value=t}},{key:"valueType",get:function(){return P.VariablePointer}},{key:"isTruthy",get:function(){throw new Error("Shouldn't be checking the truthiness of a variable pointer")}},{key:"Cast",value:function(t){if(t==this.valueType)return this;throw this.BadCastException(t)}},{key:"toString",value:function(){return"VariablePointerValue("+this.variableName+")"}},{key:"Copy",value:function(){return new i(this.variableName,this.contextIndex)}}]),i}(),K=function(){u(r,M);var i=v(r);function r(t,e){var n;return d(this,r),n=i.call(this,null),t||e?t instanceof B?n.value=new B(t):t instanceof D&&"number"==typeof e&&(n.value=new B({Key:t,Value:e})):n.value=new B,n}return o(r,[{key:"isTruthy",get:function(){return null===this.value?R("this.value"):0<this.value.Count}},{key:"valueType",get:function(){return P.List}},{key:"Cast",value:function(t){if(null===this.value)return R("Value.value");if(t==P.Int){var e=this.value.maxItem;return e.Key.isNull?new J(0):new J(e.Value)}if(t==P.Float){var n=this.value.maxItem;return n.Key.isNull?new A(0):new A(n.Value)}if(t==P.String){n=this.value.maxItem;return n.Key.isNull?new U(""):new U(n.Key.toString())}if(t==this.valueType)return this;throw this.BadCastException(t)}}],[{key:"RetainListOriginsForAssignment",value:function(t,e){t=V(t,r),e=V(e,r);return e&&null===e.value?R("newList.value"):t&&null===t.value?R("oldList.value"):void(t&&e&&0==e.value.Count&&e.value.SetInitialOriginNames(t.value.originNames))}}]),r}();(pt=P=P||{})[pt.Bool=-1]="Bool",pt[pt.Int=0]="Int",pt[pt.Float=1]="Float",pt[pt.List=2]="List",pt[pt.String=3]="String",pt[pt.DivertTarget=4]="DivertTarget",pt[pt.VariablePointer=5]="VariablePointer";var x=function(){function e(){d(this,e),this.obj=null,this.approximate=!1}return o(e,[{key:"correctObj",get:function(){return this.approximate?null:this.obj}},{key:"container",get:function(){return this.obj instanceof z?this.obj:null}},{key:"copy",value:function(){var t=new e;return t.obj=this.obj,t.approximate=this.approximate,t}}]),e}(),z=function(){u(p,T);var e=v(p);function p(){var t;return d(this,p),(t=e.apply(this,arguments)).name="",t._content=[],t.namedContent=new Map,t.visitsShouldBeCounted=!1,t.turnIndexShouldBeCounted=!1,t.countingAtStartOnly=!1,t._pathToFirstLeafContent=null,t}return o(p,[{key:"hasValidName",get:function(){return null!=this.name&&0<this.name.length}},{key:"content",get:function(){return this._content},set:function(t){this.AddContent(t)}},{key:"namedOnlyContent",get:function(){var t,e=new Map,n=W(this.namedContent);try{for(n.s();!(t=n.n()).done;){var i=S(t.value,2),r=i[0],a=L(i[1],T);e.set(r,a)}}catch(t){n.e(t)}finally{n.f()}var s,o=W(this.content);try{for(o.s();!(s=o.n()).done;){var u=_(s.value);null!=u&&u.hasValidName&&e.delete(u.name)}}catch(t){o.e(t)}finally{o.f()}return e=0==e.size?null:e},set:function(t){var e=this.namedOnlyContent;if(null!=e){var n,i=W(e);try{for(i.s();!(n=i.n()).done;){var r=S(n.value,1)[0];this.namedContent.delete(r)}}catch(t){i.e(t)}finally{i.f()}}if(null!=t){var a,s=W(t);try{for(s.s();!(a=s.n()).done;){var o=_(S(a.value,2)[1]);null!=o&&this.AddToNamedContentOnly(o)}}catch(t){s.e(t)}finally{s.f()}}}},{key:"countFlags",get:function(){var t=0;return this.visitsShouldBeCounted&&(t|=p.CountFlags.Visits),this.turnIndexShouldBeCounted&&(t|=p.CountFlags.Turns),this.countingAtStartOnly&&(t|=p.CountFlags.CountStartOnly),t=t==p.CountFlags.CountStartOnly?0:t},set:function(t){0<(t&p.CountFlags.Visits)&&(this.visitsShouldBeCounted=!0),0<(t&p.CountFlags.Turns)&&(this.turnIndexShouldBeCounted=!0),0<(t&p.CountFlags.CountStartOnly)&&(this.countingAtStartOnly=!0)}},{key:"pathToFirstLeafContent",get:function(){return null==this._pathToFirstLeafContent&&(this._pathToFirstLeafContent=this.path.PathByAppendingPath(this.internalPathToFirstLeafContent)),this._pathToFirstLeafContent}},{key:"internalPathToFirstLeafContent",get:function(){for(var t=[],e=this;e instanceof p;)0<e.content.length&&(t.push(new C.Component(0)),e=e.content[0]);return new C(t)}},{key:"AddContent",value:function(t){if(t instanceof Array){var e,n=W(t);try{for(n.s();!(e=n.n()).done;){var i=e.value;this.AddContent(i)}}catch(t){n.e(t)}finally{n.f()}}else{t=t;if(this._content.push(t),t.parent)throw new Error("content is already in "+t.parent);(t.parent=this).TryAddNamedContent(t)}}},{key:"TryAddNamedContent",value:function(t){t=_(t);null!=t&&t.hasValidName&&this.AddToNamedContentOnly(t)}},{key:"AddToNamedContentOnly",value:function(t){k.AssertType(t,T,"Can only add Runtime.Objects to a Runtime.Container"),(L(t,T).parent=this).namedContent.set(t.name,t)}},{key:"ContentAtPath",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:-1;-1==n&&(n=t.length);var i=new x;i.approximate=!1;for(var r=this,a=this,s=e;s<n;++s){var o=t.GetComponent(s);if(null==r){i.approximate=!0;break}o=r.ContentWithPathComponent(o);if(null==o){i.approximate=!0;break}r=V(a=o,p)}return i.obj=a,i}},{key:"InsertContent",value:function(t,e){if((this.content[e]=t).parent)throw new Error("content is already in "+t.parent);(t.parent=this).TryAddNamedContent(t)}},{key:"AddContentsOfContainer",value:function(t){this.content=this.content.concat(t.content);var e,n=W(t.content);try{for(n.s();!(e=n.n()).done;){var i=e.value;(i.parent=this).TryAddNamedContent(i)}}catch(t){n.e(t)}finally{n.f()}}},{key:"ContentWithPathComponent",value:function(t){if(t.isIndex)return 0<=t.index&&t.index<this.content.length?this.content[t.index]:null;if(t.isParent)return this.parent;if(null===t.name)return R("component.name");t=E(this.namedContent,t.name,null);return t.exists?L(t.result,T):null}},{key:"BuildStringOfHierarchy",value:function(){if(0==arguments.length)return e=new j,this.BuildStringOfHierarchy(e,0,null),e.toString();var e=arguments[0],n=arguments[1],t=arguments[2];function i(){for(var t=0;t<4*n;++t)e.Append(" ")}i(),e.Append("["),this.hasValidName&&e.AppendFormat(" ({0})",this.name),this==t&&e.Append("  <---"),e.AppendLine(),n++;for(var r=0;r<this.content.length;++r){var a=this.content[r];a instanceof p?a.BuildStringOfHierarchy(e,n,t):(i(),a instanceof U?(e.Append('"'),e.Append(a.toString().replace("\n","\\n")),e.Append('"')):e.Append(a.toString())),r!=this.content.length-1&&e.Append(","),a instanceof p||a!=t||e.Append("  <---"),e.AppendLine()}var s,o=new Map,u=W(this.namedContent);try{for(u.s();!(s=u.n()).done;){var l=S(s.value,2),h=l[0],c=l[1];0<=this.content.indexOf(L(c,T))||o.set(h,c)}}catch(t){u.e(t)}finally{u.f()}if(0<o.size){i(),e.AppendLine("-- named: --");var f,v=W(o);try{for(v.s();!(f=v.n()).done;){var d=S(f.value,2)[1];k.AssertType(d,p,"Can only print out named Containers"),d.BuildStringOfHierarchy(e,n,t),e.AppendLine()}}catch(t){v.e(t)}finally{v.f()}}n--,i(),e.Append("]")}}]),p}();(pt=(pt=z=z||{}).CountFlags||(pt.CountFlags={}))[pt.Visits=1]="Visits",pt[pt.Turns=2]="Turns",pt[pt.CountStartOnly=4]="CountStartOnly";var H,F=function(){u(e,T);var t=v(e);function e(){return d(this,e),t.apply(this,arguments)}return o(e,[{key:"toString",value:function(){return"Glue"}}]),e}(),X=function(){u(i,T);var n=v(i);function i(){var t,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:i.CommandType.NotSet;return d(this,i),(t=n.call(this))._commandType=e,t}return o(i,[{key:"commandType",get:function(){return this._commandType}},{key:"Copy",value:function(){return new i(this.commandType)}},{key:"toString",value:function(){return this.commandType.toString()}}],[{key:"EvalStart",value:function(){return new i(i.CommandType.EvalStart)}},{key:"EvalOutput",value:function(){return new i(i.CommandType.EvalOutput)}},{key:"EvalEnd",value:function(){return new i(i.CommandType.EvalEnd)}},{key:"Duplicate",value:function(){return new i(i.CommandType.Duplicate)}},{key:"PopEvaluatedValue",value:function(){return new i(i.CommandType.PopEvaluatedValue)}},{key:"PopFunction",value:function(){return new i(i.CommandType.PopFunction)}},{key:"PopTunnel",value:function(){return new i(i.CommandType.PopTunnel)}},{key:"BeginString",value:function(){return new i(i.CommandType.BeginString)}},{key:"EndString",value:function(){return new i(i.CommandType.EndString)}},{key:"NoOp",value:function(){return new i(i.CommandType.NoOp)}},{key:"ChoiceCount",value:function(){return new i(i.CommandType.ChoiceCount)}},{key:"Turns",value:function(){return new i(i.CommandType.Turns)}},{key:"TurnsSince",value:function(){return new i(i.CommandType.TurnsSince)}},{key:"ReadCount",value:function(){return new i(i.CommandType.ReadCount)}},{key:"Random",value:function(){return new i(i.CommandType.Random)}},{key:"SeedRandom",value:function(){return new i(i.CommandType.SeedRandom)}},{key:"VisitIndex",value:function(){return new i(i.CommandType.VisitIndex)}},{key:"SequenceShuffleIndex",value:function(){return new i(i.CommandType.SequenceShuffleIndex)}},{key:"StartThread",value:function(){return new i(i.CommandType.StartThread)}},{key:"Done",value:function(){return new i(i.CommandType.Done)}},{key:"End",value:function(){return new i(i.CommandType.End)}},{key:"ListFromInt",value:function(){return new i(i.CommandType.ListFromInt)}},{key:"ListRange",value:function(){return new i(i.CommandType.ListRange)}},{key:"ListRandom",value:function(){return new i(i.CommandType.ListRandom)}}]),i}();(pt=(pt=X=X||{}).CommandType||(pt.CommandType={}))[pt.NotSet=-1]="NotSet",pt[pt.EvalStart=0]="EvalStart",pt[pt.EvalOutput=1]="EvalOutput",pt[pt.EvalEnd=2]="EvalEnd",pt[pt.Duplicate=3]="Duplicate",pt[pt.PopEvaluatedValue=4]="PopEvaluatedValue",pt[pt.PopFunction=5]="PopFunction",pt[pt.PopTunnel=6]="PopTunnel",pt[pt.BeginString=7]="BeginString",pt[pt.EndString=8]="EndString",pt[pt.NoOp=9]="NoOp",pt[pt.ChoiceCount=10]="ChoiceCount",pt[pt.Turns=11]="Turns",pt[pt.TurnsSince=12]="TurnsSince",pt[pt.Random=13]="Random",pt[pt.SeedRandom=14]="SeedRandom",pt[pt.VisitIndex=15]="VisitIndex",pt[pt.SequenceShuffleIndex=16]="SequenceShuffleIndex",pt[pt.StartThread=17]="StartThread",pt[pt.Done=18]="Done",pt[pt.End=19]="End",pt[pt.ListFromInt=20]="ListFromInt",pt[pt.ListRange=21]="ListRange",pt[pt.ListRandom=22]="ListRandom",pt[pt.ReadCount=23]="ReadCount",pt[pt.TOTAL_VALUES=24]="TOTAL_VALUES",(pt=H=H||{})[pt.Tunnel=0]="Tunnel",pt[pt.Function=1]="Function",pt[pt.FunctionEvaluationFromGame=2]="FunctionEvaluationFromGame";var $=function(){function e(){d(this,e),this.container=null,this.index=-1,2===arguments.length&&(this.container=arguments[0],this.index=arguments[1])}return o(e,[{key:"Resolve",value:function(){return this.index<0?this.container:null==this.container?null:0==this.container.content.length?this.container:this.index>=this.container.content.length?null:this.container.content[this.index]}},{key:"isNull",get:function(){return null==this.container}},{key:"path",get:function(){return this.isNull?null:0<=this.index?this.container.path.PathByAppendingComponent(new C.Component(this.index)):this.container.path}},{key:"toString",value:function(){return this.container?"Ink Pointer -> "+this.container.path.toString()+" -- index "+this.index:"Ink Pointer (null)"}},{key:"copy",value:function(){return new e(this.container,this.index)}}],[{key:"StartOf",value:function(t){return new e(t,0)}},{key:"Null",get:function(){return new e(null,-1)}}]),e}(),Y=function(){u(i,T);var n=v(i);function i(t){var e;return d(this,i),(e=n.call(this))._targetPath=null,e._targetPointer=$.Null,e.variableDivertName=null,e.pushesToStack=!1,e.stackPushType=0,e.isExternal=!1,e.externalArgs=0,e.isConditional=!1,e.pushesToStack=!1,void 0!==t&&(e.pushesToStack=!0,e.stackPushType=t),e}return o(i,[{key:"targetPath",get:function(){var t;return null==this._targetPath||!this._targetPath.isRelative||(t=this.targetPointer.Resolve())&&(this._targetPath=t.path),this._targetPath},set:function(t){this._targetPath=t,this._targetPointer=$.Null}},{key:"targetPointer",get:function(){if(this._targetPointer.isNull){var t=this.ResolvePath(this._targetPath).obj;if(null===this._targetPath)return R("this._targetPath");if(null===this._targetPath.lastComponent)return R("this._targetPath.lastComponent");if(this._targetPath.lastComponent.isIndex){if(null===t)return R("targetObj");this._targetPointer.container=t.parent instanceof z?t.parent:null,this._targetPointer.index=this._targetPath.lastComponent.index}else this._targetPointer=$.StartOf(t instanceof z?t:null)}return this._targetPointer.copy()}},{key:"targetPathString",get:function(){return null==this.targetPath?null:this.CompactPathString(this.targetPath)},set:function(t){this.targetPath=null==t?null:new C(t)}},{key:"hasVariableTarget",get:function(){return null!=this.variableDivertName}},{key:"Equals",value:function(t){return t instanceof i&&this.hasVariableTarget==t.hasVariableTarget&&(this.hasVariableTarget?this.variableDivertName==t.variableDivertName:null===this.targetPath?R("this.targetPath"):this.targetPath.Equals(t.targetPath))}},{key:"toString",value:function(){if(this.hasVariableTarget)return"Divert(variable: "+this.variableDivertName+")";if(null==this.targetPath)return"Divert(null)";var t=new j,e=this.targetPath.toString();return t.Append("Divert"),this.isConditional&&t.Append("?"),this.pushesToStack&&(this.stackPushType==H.Function?t.Append(" function"):t.Append(" tunnel")),t.Append(" -> "),t.Append(this.targetPathString),t.Append(" ("),t.Append(e),t.Append(")"),t.toString()}}]),i}(),Q=function(){u(i,T);var n=v(i);function i(){var t,e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];return d(this,i),(t=n.call(this))._pathOnChoice=null,t.hasCondition=!1,t.hasStartContent=!1,t.hasChoiceOnlyContent=!1,t.isInvisibleDefault=!1,t.onceOnly=!0,t.onceOnly=e,t}return o(i,[{key:"pathOnChoice",get:function(){var t;return null==this._pathOnChoice||!this._pathOnChoice.isRelative||(t=this.choiceTarget)&&(this._pathOnChoice=t.path),this._pathOnChoice},set:function(t){this._pathOnChoice=t}},{key:"choiceTarget",get:function(){return null===this._pathOnChoice?R("ChoicePoint._pathOnChoice"):this.ResolvePath(this._pathOnChoice).container}},{key:"pathStringOnChoice",get:function(){return null===this.pathOnChoice?R("ChoicePoint.pathOnChoice"):this.CompactPathString(this.pathOnChoice)},set:function(t){this.pathOnChoice=new C(t)}},{key:"flags",get:function(){var t=0;return this.hasCondition&&(t|=1),this.hasStartContent&&(t|=2),this.hasChoiceOnlyContent&&(t|=4),this.isInvisibleDefault&&(t|=8),this.onceOnly&&(t|=16),t},set:function(t){this.hasCondition=0<(1&t),this.hasStartContent=0<(2&t),this.hasChoiceOnlyContent=0<(4&t),this.isInvisibleDefault=0<(8&t),this.onceOnly=0<(16&t)}},{key:"toString",value:function(){return null===this.pathOnChoice?R("ChoicePoint.pathOnChoice"):"Choice: -> "+this.pathOnChoice.toString()}}]),i}(),Z=function(){u(i,T);var n=v(i);function i(){var t,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null;return d(this,i),(t=n.call(this)).pathForCount=null,t.name=e,t}return o(i,[{key:"containerForCount",get:function(){return null===this.pathForCount?null:this.ResolvePath(this.pathForCount).container}},{key:"pathStringForCount",get:function(){return null===this.pathForCount?null:this.CompactPathString(this.pathForCount)},set:function(t){this.pathForCount=null===t?null:new C(t)}},{key:"toString",value:function(){return null!=this.name?"var("+this.name+")":"read_count("+this.pathStringForCount+")"}}]),i}(),tt=function(){u(r,T);var i=v(r);function r(t,e){var n;return d(this,r),(n=i.call(this)).variableName=t||null,n.isNewDeclaration=!!e,n.isGlobal=!1,n}return o(r,[{key:"toString",value:function(){return"VarAssign to "+this.variableName}}]),r}(),et=function(){u(e,T);var t=v(e);function e(){return d(this,e),t.apply(this,arguments)}return e}(),nt=function(){u(s,T);var i=v(s);function s(){var t,e,n;return d(this,s),(t=i.call(this))._name=null,t._numberOfParameters=0,t._prototype=null,t._isPrototype=!1,t._operationFuncs=null,0===arguments.length?s.GenerateNativeFunctionsIfNecessary():1===arguments.length?(n=arguments[0],s.GenerateNativeFunctionsIfNecessary(),t.name=n):2===arguments.length&&(e=arguments[0],n=arguments[1],t._isPrototype=!0,t.name=e,t.numberOfParameters=n),t}return o(s,[{key:"name",get:function(){return null===this._name?R("NativeFunctionCall._name"):this._name},set:function(t){this._name=t,this._isPrototype||(null===s._nativeFunctions?R("NativeFunctionCall._nativeFunctions"):this._prototype=s._nativeFunctions.get(this._name)||null)}},{key:"numberOfParameters",get:function(){return this._prototype?this._prototype.numberOfParameters:this._numberOfParameters},set:function(t){this._numberOfParameters=t}},{key:"Call",value:function(t){if(this._prototype)return this._prototype.Call(t);if(this.numberOfParameters!=t.length)throw new Error("Unexpected number of parameters");var e,n=!1,i=W(t);try{for(i.s();!(e=i.n()).done;){var r=e.value;if(r instanceof et)throw new G('Attempting to perform operation on a void value. Did you forget to "return" a value from a function you called here?');r instanceof K&&(n=!0)}}catch(t){i.e(t)}finally{i.f()}if(2==t.length&&n)return this.CallBinaryListOperation(t);var a=this.CoerceValuesToSingleType(t),t=a[0].valueType;return t==P.Int||t==P.Float||t==P.String||t==P.DivertTarget||t==P.List?this.CallType(a):null}},{key:"CallType",value:function(t){var e=L(t[0],M),n=e.valueType,i=e,r=t.length;if(2!=r&&1!=r)throw new Error("Unexpected number of parameters to NativeFunctionCall: "+t.length);if(null===this._operationFuncs)return R("NativeFunctionCall._operationFuncs");var a=this._operationFuncs.get(n);if(!a){n=P[n];throw new G("Cannot perform operation "+this.name+" on "+n)}if(2==r){r=L(t[1],M),t=a;if(null===i.value||null===r.value)return R("NativeFunctionCall.Call BinaryOp values");r=t(i.value,r.value);return M.Create(r)}if(null===i.value)return R("NativeFunctionCall.Call UnaryOp value");i=a(i.value);return this.name===s.Int?M.Create(i,P.Int):this.name===s.Float?M.Create(i,P.Float):M.Create(i,e.valueType)}},{key:"CallBinaryListOperation",value:function(t){if(("+"==this.name||"-"==this.name)&&t[0]instanceof K&&t[1]instanceof J)return this.CallListIncrementOperation(t);var e=L(t[0],M),n=L(t[1],M);if(!("&&"!=this.name&&"||"!=this.name||e.valueType==P.List&&n.valueType==P.List)){if(null===this._operationFuncs)return R("NativeFunctionCall._operationFuncs");t=this._operationFuncs.get(P.Int);if(null===t)return R("NativeFunctionCall.CallBinaryListOperation op");t=function(t){if("boolean"==typeof t)return t;throw new Error("".concat(t," is not a boolean"))}(t(e.isTruthy?1:0,n.isTruthy?1:0));return new N(t)}if(e.valueType==P.List&&n.valueType==P.List)return this.CallType([e,n]);throw new G("Can not call use "+this.name+" operation on "+P[e.valueType]+" and "+P[n.valueType])}},{key:"CallListIncrementOperation",value:function(t){var e=L(t[0],K),n=L(t[1],J),i=new B;if(null===e.value)return R("NativeFunctionCall.CallListIncrementOperation listVal.value");var r,a=W(e.value);try{for(a.s();!(r=a.n()).done;){var s=S(r.value,2),o=s[0],u=s[1],l=D.fromSerializedKey(o);if(null===this._operationFuncs)return R("NativeFunctionCall._operationFuncs");var h=this._operationFuncs.get(P.Int);if(null===n.value)return R("NativeFunctionCall.CallListIncrementOperation intVal.value");var c=h(u,n.value),f=null;if(null===e.value.origins)return R("NativeFunctionCall.CallListIncrementOperation listVal.value.origins");var v,d,p=W(e.value.origins);try{for(p.s();!(v=p.n()).done;){var y=v.value;if(y.name==l.originName){f=y;break}}}catch(t){p.e(t)}finally{p.f()}null==f||(d=f.TryGetItemWithValue(c,D.Null)).exists&&i.Add(d.result,c)}}catch(t){a.e(t)}finally{a.f()}return new K(i)}},{key:"CoerceValuesToSingleType",value:function(t){var e,n=P.Int,i=null,r=W(t);try{for(r.s();!(e=r.n()).done;){var a=L(e.value,M);a.valueType>n&&(n=a.valueType),a.valueType==P.List&&(i=V(a,K))}}catch(t){r.e(t)}finally{r.f()}var s=[];if(P[n]==P[P.List]){var o,u=W(t);try{for(u.s();!(o=u.n()).done;){var l=L(o.value,M);if(l.valueType==P.List)s.push(l);else{if(l.valueType!=P.Int){var h=P[l.valueType];throw new G("Cannot mix Lists and "+h+" values in this operation")}var c=parseInt(l.valueObject);if(null===(i=L(i,K)).value)return R("NativeFunctionCall.CoerceValuesToSingleType specialCaseList.value");var f=i.value.originOfMaxItem;if(null===f)return R("NativeFunctionCall.CoerceValuesToSingleType list");var v=f.TryGetItemWithValue(c,D.Null);if(!v.exists)throw new G("Could not find List item with the value "+c+" in "+f.name);var d=new K(v.result,c);s.push(d)}}}catch(t){u.e(t)}finally{u.f()}}else{var p,y=W(t);try{for(y.s();!(p=y.n()).done;){var m=L(p.value,M).Cast(n);s.push(m)}}catch(t){y.e(t)}finally{y.f()}}return s}},{key:"AddOpFuncForType",value:function(t,e){null==this._operationFuncs&&(this._operationFuncs=new Map),this._operationFuncs.set(t,e)}},{key:"toString",value:function(){return'Native "'+this.name+'"'}}],[{key:"CallWithName",value:function(t){return new s(t)}},{key:"CallExistsWithName",value:function(t){return this.GenerateNativeFunctionsIfNecessary(),this._nativeFunctions.get(t)}},{key:"Identity",value:function(t){return t}},{key:"GenerateNativeFunctionsIfNecessary",value:function(){null==this._nativeFunctions&&(this._nativeFunctions=new Map,this.AddIntBinaryOp(this.Add,function(t,e){return t+e}),this.AddIntBinaryOp(this.Subtract,function(t,e){return t-e}),this.AddIntBinaryOp(this.Multiply,function(t,e){return t*e}),this.AddIntBinaryOp(this.Divide,function(t,e){return Math.floor(t/e)}),this.AddIntBinaryOp(this.Mod,function(t,e){return t%e}),this.AddIntUnaryOp(this.Negate,function(t){return-t}),this.AddIntBinaryOp(this.Equal,function(t,e){return t==e}),this.AddIntBinaryOp(this.Greater,function(t,e){return e<t}),this.AddIntBinaryOp(this.Less,function(t,e){return t<e}),this.AddIntBinaryOp(this.GreaterThanOrEquals,function(t,e){return e<=t}),this.AddIntBinaryOp(this.LessThanOrEquals,function(t,e){return t<=e}),this.AddIntBinaryOp(this.NotEquals,function(t,e){return t!=e}),this.AddIntUnaryOp(this.Not,function(t){return 0==t}),this.AddIntBinaryOp(this.And,function(t,e){return 0!=t&&0!=e}),this.AddIntBinaryOp(this.Or,function(t,e){return 0!=t||0!=e}),this.AddIntBinaryOp(this.Max,function(t,e){return Math.max(t,e)}),this.AddIntBinaryOp(this.Min,function(t,e){return Math.min(t,e)}),this.AddIntBinaryOp(this.Pow,function(t,e){return Math.pow(t,e)}),this.AddIntUnaryOp(this.Floor,s.Identity),this.AddIntUnaryOp(this.Ceiling,s.Identity),this.AddIntUnaryOp(this.Int,s.Identity),this.AddIntUnaryOp(this.Float,function(t){return t}),this.AddFloatBinaryOp(this.Add,function(t,e){return t+e}),this.AddFloatBinaryOp(this.Subtract,function(t,e){return t-e}),this.AddFloatBinaryOp(this.Multiply,function(t,e){return t*e}),this.AddFloatBinaryOp(this.Divide,function(t,e){return t/e}),this.AddFloatBinaryOp(this.Mod,function(t,e){return t%e}),this.AddFloatUnaryOp(this.Negate,function(t){return-t}),this.AddFloatBinaryOp(this.Equal,function(t,e){return t==e}),this.AddFloatBinaryOp(this.Greater,function(t,e){return e<t}),this.AddFloatBinaryOp(this.Less,function(t,e){return t<e}),this.AddFloatBinaryOp(this.GreaterThanOrEquals,function(t,e){return e<=t}),this.AddFloatBinaryOp(this.LessThanOrEquals,function(t,e){return t<=e}),this.AddFloatBinaryOp(this.NotEquals,function(t,e){return t!=e}),this.AddFloatUnaryOp(this.Not,function(t){return 0==t}),this.AddFloatBinaryOp(this.And,function(t,e){return 0!=t&&0!=e}),this.AddFloatBinaryOp(this.Or,function(t,e){return 0!=t||0!=e}),this.AddFloatBinaryOp(this.Max,function(t,e){return Math.max(t,e)}),this.AddFloatBinaryOp(this.Min,function(t,e){return Math.min(t,e)}),this.AddFloatBinaryOp(this.Pow,function(t,e){return Math.pow(t,e)}),this.AddFloatUnaryOp(this.Floor,function(t){return Math.floor(t)}),this.AddFloatUnaryOp(this.Ceiling,function(t){return Math.ceil(t)}),this.AddFloatUnaryOp(this.Int,function(t){return Math.floor(t)}),this.AddFloatUnaryOp(this.Float,s.Identity),this.AddStringBinaryOp(this.Add,function(t,e){return t+e}),this.AddStringBinaryOp(this.Equal,function(t,e){return t===e}),this.AddStringBinaryOp(this.NotEquals,function(t,e){return!(t===e)}),this.AddStringBinaryOp(this.Has,function(t,e){return t.includes(e)}),this.AddStringBinaryOp(this.Hasnt,function(t,e){return!t.includes(e)}),this.AddListBinaryOp(this.Add,function(t,e){return t.Union(e)}),this.AddListBinaryOp(this.Subtract,function(t,e){return t.Without(e)}),this.AddListBinaryOp(this.Has,function(t,e){return t.Contains(e)}),this.AddListBinaryOp(this.Hasnt,function(t,e){return!t.Contains(e)}),this.AddListBinaryOp(this.Intersect,function(t,e){return t.Intersect(e)}),this.AddListBinaryOp(this.Equal,function(t,e){return t.Equals(e)}),this.AddListBinaryOp(this.Greater,function(t,e){return t.GreaterThan(e)}),this.AddListBinaryOp(this.Less,function(t,e){return t.LessThan(e)}),this.AddListBinaryOp(this.GreaterThanOrEquals,function(t,e){return t.GreaterThanOrEquals(e)}),this.AddListBinaryOp(this.LessThanOrEquals,function(t,e){return t.LessThanOrEquals(e)}),this.AddListBinaryOp(this.NotEquals,function(t,e){return!t.Equals(e)}),this.AddListBinaryOp(this.And,function(t,e){return 0<t.Count&&0<e.Count}),this.AddListBinaryOp(this.Or,function(t,e){return 0<t.Count||0<e.Count}),this.AddListUnaryOp(this.Not,function(t){return 0==t.Count?1:0}),this.AddListUnaryOp(this.Invert,function(t){return t.inverse}),this.AddListUnaryOp(this.All,function(t){return t.all}),this.AddListUnaryOp(this.ListMin,function(t){return t.MinAsList()}),this.AddListUnaryOp(this.ListMax,function(t){return t.MaxAsList()}),this.AddListUnaryOp(this.Count,function(t){return t.Count}),this.AddListUnaryOp(this.ValueOfList,function(t){return t.maxItem.Value}),this.AddOpToNativeFunc(this.Equal,2,P.DivertTarget,function(t,e){return t.Equals(e)}),this.AddOpToNativeFunc(this.NotEquals,2,P.DivertTarget,function(t,e){return!t.Equals(e)}))}},{key:"AddOpToNativeFunc",value:function(t,e,n,i){if(null===this._nativeFunctions)return R("NativeFunctionCall._nativeFunctions");var r=this._nativeFunctions.get(t);r||(r=new s(t,e),this._nativeFunctions.set(t,r)),r.AddOpFuncForType(n,i)}},{key:"AddIntBinaryOp",value:function(t,e){this.AddOpToNativeFunc(t,2,P.Int,e)}},{key:"AddIntUnaryOp",value:function(t,e){this.AddOpToNativeFunc(t,1,P.Int,e)}},{key:"AddFloatBinaryOp",value:function(t,e){this.AddOpToNativeFunc(t,2,P.Float,e)}},{key:"AddFloatUnaryOp",value:function(t,e){this.AddOpToNativeFunc(t,1,P.Float,e)}},{key:"AddStringBinaryOp",value:function(t,e){this.AddOpToNativeFunc(t,2,P.String,e)}},{key:"AddListBinaryOp",value:function(t,e){this.AddOpToNativeFunc(t,2,P.List,e)}},{key:"AddListUnaryOp",value:function(t,e){this.AddOpToNativeFunc(t,1,P.List,e)}}]),s}();nt.Add="+",nt.Subtract="-",nt.Divide="/",nt.Multiply="*",nt.Mod="%",nt.Negate="_",nt.Equal="==",nt.Greater=">",nt.Less="<",nt.GreaterThanOrEquals=">=",nt.LessThanOrEquals="<=",nt.NotEquals="!=",nt.Not="!",nt.And="&&",nt.Or="||",nt.Min="MIN",nt.Max="MAX",nt.Pow="POW",nt.Floor="FLOOR",nt.Ceiling="CEILING",nt.Int="INT",nt.Float="FLOAT",nt.Has="?",nt.Hasnt="!?",nt.Intersect="^",nt.ListMin="LIST_MIN",nt.ListMax="LIST_MAX",nt.All="LIST_ALL",nt.Count="LIST_COUNT",nt.ValueOfList="LIST_VALUE",nt.Invert="LIST_INVERT",nt._nativeFunctions=null;var it=function(){u(i,T);var n=v(i);function i(t){var e;return d(this,i),(e=n.call(this)).text=t.toString()||"",e}return o(i,[{key:"toString",value:function(){return"# "+this.text}}]),i}(),rt=function(){u(n,T);var e=v(n);function n(){var t;return d(this,n),(t=e.apply(this,arguments)).text="",t.index=0,t.threadAtGeneration=null,t.sourcePath="",t.targetPath=null,t.isInvisibleDefault=!1,t.originalThreadIndex=0,t}return o(n,[{key:"pathStringOnChoice",get:function(){return null===this.targetPath?R("Choice.targetPath"):this.targetPath.toString()},set:function(t){this.targetPath=new C(t)}}]),n}(),at=function(){function n(t,e){d(this,n),this._name=t||"",this._items=null,this._itemNameToValues=e||new Map}return o(n,[{key:"name",get:function(){return this._name}},{key:"items",get:function(){if(null==this._items){this._items=new Map;var t,e=W(this._itemNameToValues);try{for(e.s();!(t=e.n()).done;){var n=S(t.value,2),i=n[0],r=n[1],a=new D(this.name,i);this._items.set(a.serialized(),r)}}catch(t){e.e(t)}finally{e.f()}}return this._items}},{key:"ValueForItem",value:function(t){if(!t.itemName)return 0;t=this._itemNameToValues.get(t.itemName);return void 0!==t?t:0}},{key:"ContainsItem",value:function(t){return!!t.itemName&&(t.originName==this.name&&this._itemNameToValues.has(t.itemName))}},{key:"ContainsItemWithName",value:function(t){return this._itemNameToValues.has(t)}},{key:"TryGetItemWithValue",value:function(t,e){var n,i=W(this._itemNameToValues);try{for(i.s();!(n=i.n()).done;){var r=S(n.value,2),a=r[0];if(r[1]==t)return{result:new D(this.name,a),exists:!0}}}catch(t){i.e(t)}finally{i.f()}return{result:D.Null,exists:!1}}},{key:"TryGetValueForItem",value:function(t,e){if(!t.itemName)return{result:0,exists:!1};t=this._itemNameToValues.get(t.itemName);return t?{result:t,exists:!0}:{result:0,exists:!1}}}]),n}(),st=function(){function c(t){d(this,c),this._lists=new Map,this._allUnambiguousListValueCache=new Map;var e,n=W(t);try{for(n.s();!(e=n.n()).done;){var i=e.value;this._lists.set(i.name,i);var r,a=W(i.items);try{for(a.s();!(r=a.n()).done;){var s=S(r.value,2),o=s[0],u=s[1],l=D.fromSerializedKey(o),h=new K(l,u);if(!l.itemName)throw new Error("item.itemName is null or undefined.");this._allUnambiguousListValueCache.set(l.itemName,h),this._allUnambiguousListValueCache.set(l.fullName,h)}}catch(t){a.e(t)}finally{a.f()}}}catch(t){n.e(t)}finally{n.f()}}return o(c,[{key:"lists",get:function(){var t,e=[],n=W(this._lists);try{for(n.s();!(t=n.n()).done;){var i=S(t.value,2)[1];e.push(i)}}catch(t){n.e(t)}finally{n.f()}return e}},{key:"TryListGetDefinition",value:function(t,e){if(null===t)return{result:e,exists:!1};t=this._lists.get(t);return t?{result:t,exists:!0}:{result:e,exists:!1}}},{key:"FindSingleItemListWithName",value:function(t){if(null===t)return R("name");t=this._allUnambiguousListValueCache.get(t);return void 0!==t?t:null}}]),c}(),ot=function(){function m(){d(this,m)}return o(m,null,[{key:"JArrayToRuntimeObjList",value:function(t){var e=t.length;1<arguments.length&&void 0!==arguments[1]&&arguments[1]&&e--;for(var n=[],i=0;i<e;i++){var r=t[i],r=this.JTokenToRuntimeObject(r);if(null===r)return R("runtimeObj");n.push(r)}return n}},{key:"WriteDictionaryRuntimeObjs",value:function(t,e){t.WriteObjectStart();var n,i=W(e);try{for(i.s();!(n=i.n()).done;){var r=S(n.value,2),a=r[0],s=r[1];t.WritePropertyStart(a),this.WriteRuntimeObject(t,s),t.WritePropertyEnd()}}catch(t){i.e(t)}finally{i.f()}t.WriteObjectEnd()}},{key:"WriteListRuntimeObjs",value:function(t,e){t.WriteArrayStart();var n,i=W(e);try{for(i.s();!(n=i.n()).done;){var r=n.value;this.WriteRuntimeObject(t,r)}}catch(t){i.e(t)}finally{i.f()}t.WriteArrayEnd()}},{key:"WriteIntDictionary",value:function(t,e){t.WriteObjectStart();var n,i=W(e);try{for(i.s();!(n=i.n()).done;){var r=S(n.value,2),a=r[0],s=r[1];t.WriteIntProperty(a,s)}}catch(t){i.e(t)}finally{i.f()}t.WriteObjectEnd()}},{key:"WriteRuntimeObject",value:function(t,e){var n=V(e,z);if(n)this.WriteRuntimeContainer(t,n);else{var i=V(e,Y);if(i){var r="->";return i.isExternal?r="x()":i.pushesToStack&&(i.stackPushType==H.Function?r="f()":i.stackPushType==H.Tunnel&&(r="->t->")),n=i.hasVariableTarget?i.variableDivertName:i.targetPathString,t.WriteObjectStart(),t.WriteProperty(r,n),i.hasVariableTarget&&t.WriteProperty("var",!0),i.isConditional&&t.WriteProperty("c",!0),0<i.externalArgs&&t.WriteIntProperty("exArgs",i.externalArgs),void t.WriteObjectEnd()}i=V(e,Q);if(i)return t.WriteObjectStart(),t.WriteProperty("*",i.pathStringOnChoice),t.WriteIntProperty("flg",i.flags),void t.WriteObjectEnd();i=V(e,N);if(i)t.WriteBool(i.value);else{i=V(e,J);if(i)t.WriteInt(i.value);else{i=V(e,A);if(i)t.WriteFloat(i.value);else{i=V(e,U);if(i)i.isNewline?t.Write("\n",!1):(t.WriteStringStart(),t.WriteStringInner("^"),t.WriteStringInner(i.value),t.WriteStringEnd());else{i=V(e,K);if(i)this.WriteInkList(t,i);else{i=V(e,q);if(i)return t.WriteObjectStart(),null===i.value?R("divTargetVal.value"):(t.WriteProperty("^->",i.value.componentsString),void t.WriteObjectEnd());i=V(e,I);if(i)return t.WriteObjectStart(),t.WriteProperty("^var",i.value),t.WriteIntProperty("ci",i.contextIndex),void t.WriteObjectEnd();if(V(e,F))t.Write("<>");else{i=V(e,X);if(i)t.Write(m._controlCommandNames[i.commandType]);else{i=V(e,nt);if(i){var a=i.name;t.Write(a="^"==a?"L^":a)}else{a=V(e,Z);if(a){t.WriteObjectStart();var s=a.pathStringForCount;return null!=s?t.WriteProperty("CNT?",s):t.WriteProperty("VAR?",a.name),void t.WriteObjectEnd()}s=V(e,tt);if(s){t.WriteObjectStart();a=s.isGlobal?"VAR=":"temp=";return t.WriteProperty(a,s.variableName),s.isNewDeclaration||t.WriteProperty("re",!0),void t.WriteObjectEnd()}if(V(e,et))t.Write("void");else{s=V(e,it);if(s)return t.WriteObjectStart(),t.WriteProperty("#",s.text),void t.WriteObjectEnd();s=V(e,rt);if(!s)throw new Error("Failed to convert runtime object to Json token: "+e);this.WriteChoice(t,s)}}}}}}}}}}}},{key:"JObjectToDictionaryRuntimeObjs",value:function(t){var e,n=new Map;for(e in t)if(t.hasOwnProperty(e)){var i=this.JTokenToRuntimeObject(t[e]);if(null===i)return R("inkObject");n.set(e,i)}return n}},{key:"JObjectToIntDictionary",value:function(t){var e,n=new Map;for(e in t)t.hasOwnProperty(e)&&n.set(e,parseInt(t[e]));return n}},{key:"JTokenToRuntimeObject",value:function(t){if("number"==typeof t&&!isNaN(t)||"boolean"==typeof t)return M.Create(t);if("string"==typeof t){var e=t.toString(),n=e[0];if("^"==n)return new U(e.substring(1));if("\n"==n&&1==e.length)return new U("\n");if("<>"==e)return new F;for(var i=0;i<m._controlCommandNames.length;++i)if(e==m._controlCommandNames[i])return new X(i);if(nt.CallExistsWithName(e="L^"==e?"^":e))return nt.CallWithName(e);if("->->"==e)return X.PopTunnel();if("~ret"==e)return X.PopFunction();if("void"==e)return new et}if("object"===g(t)&&!Array.isArray(t)){var r=t;if(r["^->"])return a=r["^->"],new q(new C(a.toString()));if(r["^var"]){var a=r["^var"],s=new I(a.toString());return"ci"in r&&(a=r.ci,s.contextIndex=parseInt(a)),s}var o=!1,u=!1,n=H.Function,s=!1;if((a=r["->"])?o=!0:(a=r["f()"])?(u=o=!0,n=H.Function):(a=r["->t->"])?(u=o=!0,n=H.Tunnel):(a=r["x()"])&&(u=!(s=o=!0),n=H.Function),o){var l=new Y;l.pushesToStack=u,l.stackPushType=n,l.isExternal=s;n=a.toString();return(a=r.var)?l.variableDivertName=n:l.targetPathString=n,l.isConditional=!!r.c,s&&(a=r.exArgs)&&(l.externalArgs=parseInt(a)),l}if(a=r["*"]){var h=new Q;return h.pathStringOnChoice=a.toString(),(a=r.flg)&&(h.flags=parseInt(a)),h}if(a=r["VAR?"])return new Z(a.toString());if(a=r["CNT?"]){var c=new Z;return c.pathStringForCount=a.toString(),c}l=!1,h=!1;if((a=r["VAR="])?h=l=!0:(a=r["temp="])&&(h=!(l=!0)),l){c=a.toString(),l=!r.re,l=new tt(c,l);return l.isGlobal=h,l}if(void 0!==r["#"])return a=r["#"],new it(a.toString());if(a=r.list){var f,v,d,p=a,y=new B;for(f in(a=r.origins)&&y.SetInitialOriginNames(a),p)p.hasOwnProperty(f)&&(d=p[f],v=new D(f),d=parseInt(d),y.Add(v,d));return new K(y)}if(null!=r.originalChoicePath)return this.JObjectToChoice(r)}if(Array.isArray(t))return this.JArrayToContainer(t);if(null==t)return null;throw new Error("Failed to convert token to runtime object: "+JSON.stringify(t))}},{key:"WriteRuntimeContainer",value:function(t,e){var n=2<arguments.length&&void 0!==arguments[2]&&arguments[2];if(t.WriteArrayStart(),null===e)return R("container");var i,r=W(e.content);try{for(r.s();!(i=r.n()).done;){var a=i.value;this.WriteRuntimeObject(t,a)}}catch(t){r.e(t)}finally{r.f()}var s=e.namedOnlyContent,o=e.countFlags,n=null!=e.name&&!n,o=null!=s||0<o||n;if(o&&t.WriteObjectStart(),null!=s){var u,l=W(s);try{for(l.s();!(u=l.n()).done;){var h=S(u.value,2),c=h[0],f=V(h[1],z);t.WritePropertyStart(c),this.WriteRuntimeContainer(t,f,!0),t.WritePropertyEnd()}}catch(t){l.e(t)}finally{l.f()}}n&&t.WriteProperty("#n",e.name),o?t.WriteObjectEnd():t.WriteNull(),t.WriteArrayEnd()}},{key:"JArrayToContainer",value:function(t){var e=new z;e.content=this.JArrayToRuntimeObjList(t,!0);var n=t[t.length-1];if(null!=n){var i,r,a,s=new Map;for(i in n)"#f"==i?e.countFlags=parseInt(n[i]):"#n"==i?e.name=n[i].toString():((a=V(r=this.JTokenToRuntimeObject(n[i]),z))&&(a.name=i),s.set(i,r));e.namedOnlyContent=s}return e}},{key:"JObjectToChoice",value:function(t){var e=new rt;return e.text=t.text.toString(),e.index=parseInt(t.index),e.sourcePath=t.originalChoicePath.toString(),e.originalThreadIndex=parseInt(t.originalThreadIndex),e.pathStringOnChoice=t.targetPath.toString(),e}},{key:"WriteChoice",value:function(t,e){t.WriteObjectStart(),t.WriteProperty("text",e.text),t.WriteIntProperty("index",e.index),t.WriteProperty("originalChoicePath",e.sourcePath),t.WriteIntProperty("originalThreadIndex",e.originalThreadIndex),t.WriteProperty("targetPath",e.pathStringOnChoice),t.WriteObjectEnd()}},{key:"WriteInkList",value:function(t,e){e=e.value;if(null===e)return R("rawList");t.WriteObjectStart(),t.WritePropertyStart("list"),t.WriteObjectStart();var n,i=W(e);try{for(i.s();!(n=i.n()).done;){var r=S(n.value,2),a=r[0],s=r[1],o=D.fromSerializedKey(a),u=s;if(null===o.itemName)return R("item.itemName");t.WritePropertyNameStart(),t.WritePropertyNameInner(o.originName||"?"),t.WritePropertyNameInner("."),t.WritePropertyNameInner(o.itemName),t.WritePropertyNameEnd(),t.Write(u),t.WritePropertyEnd()}}catch(t){i.e(t)}finally{i.f()}if(t.WriteObjectEnd(),t.WritePropertyEnd(),0==e.Count&&null!=e.originNames&&0<e.originNames.length){t.WritePropertyStart("origins"),t.WriteArrayStart();var l,h=W(e.originNames);try{for(h.s();!(l=h.n()).done;){var c=l.value;t.Write(c)}}catch(t){h.e(t)}finally{h.f()}t.WriteArrayEnd(),t.WritePropertyEnd()}t.WriteObjectEnd()}},{key:"ListDefinitionsToJToken",value:function(t){var e,n={},i=W(t.lists);try{for(i.s();!(e=i.n()).done;){var r,a=e.value,s={},o=W(a.items);try{for(o.s();!(r=o.n()).done;){var u=S(r.value,2),l=u[0],h=u[1],c=D.fromSerializedKey(l);if(null===c.itemName)return R("item.itemName");s[c.itemName]=h}}catch(t){o.e(t)}finally{o.f()}n[a.name]=s}}catch(t){i.e(t)}finally{i.f()}return n}},{key:"JTokenToListDefinitions",value:function(t){var e,n=t,i=[];for(e in n)if(n.hasOwnProperty(e)){var r,a,s=e.toString(),o=n[e],u=new Map;for(r in o)n.hasOwnProperty(e)&&(a=o[r],u.set(r,parseInt(a)));s=new at(s,u);i.push(s)}return new st(i)}}]),m}();ot._controlCommandNames=function(){var t=[];t[X.CommandType.EvalStart]="ev",t[X.CommandType.EvalOutput]="out",t[X.CommandType.EvalEnd]="/ev",t[X.CommandType.Duplicate]="du",t[X.CommandType.PopEvaluatedValue]="pop",t[X.CommandType.PopFunction]="~ret",t[X.CommandType.PopTunnel]="->->",t[X.CommandType.BeginString]="str",t[X.CommandType.EndString]="/str",t[X.CommandType.NoOp]="nop",t[X.CommandType.ChoiceCount]="choiceCnt",t[X.CommandType.Turns]="turn",t[X.CommandType.TurnsSince]="turns",t[X.CommandType.ReadCount]="readc",t[X.CommandType.Random]="rnd",t[X.CommandType.SeedRandom]="srnd",t[X.CommandType.VisitIndex]="visit",t[X.CommandType.SequenceShuffleIndex]="seq",t[X.CommandType.StartThread]="thread",t[X.CommandType.Done]="done",t[X.CommandType.End]="end",t[X.CommandType.ListFromInt]="listInt",t[X.CommandType.ListRange]="range",t[X.CommandType.ListRandom]="lrnd";for(var e=0;e<X.CommandType.TOTAL_VALUES;++e)if(null==t[e])throw new Error("Control command not accounted for in serialisation");return t}();var ut,lt=function(){function s(){if(d(this,s),this._threadCounter=0,this._startOfRoot=$.Null,arguments[0]instanceof a.Story)this._startOfRoot=$.StartOf(arguments[0].rootContentContainer),this.Reset();else{var t=arguments[0];this._threads=[];var e,n=W(t._threads);try{for(n.s();!(e=n.n()).done;){var i=e.value;this._threads.push(i.Copy())}}catch(t){n.e(t)}finally{n.f()}this._threadCounter=t._threadCounter,this._startOfRoot=t._startOfRoot.copy()}}return o(s,[{key:"elements",get:function(){return this.callStack}},{key:"depth",get:function(){return this.elements.length}},{key:"currentElement",get:function(){var t=this._threads[this._threads.length-1].callstack;return t[t.length-1]}},{key:"currentElementIndex",get:function(){return this.callStack.length-1}},{key:"currentThread",get:function(){return this._threads[this._threads.length-1]},set:function(t){k.Assert(1==this._threads.length,"Shouldn't be directly setting the current thread when we have a stack of them"),this._threads.length=0,this._threads.push(t)}},{key:"canPop",get:function(){return 1<this.callStack.length}},{key:"Reset",value:function(){this._threads=[],this._threads.push(new s.Thread),this._threads[0].callstack.push(new s.Element(H.Tunnel,this._startOfRoot))}},{key:"SetJsonToken",value:function(t,e){this._threads.length=0;var n,i=W(t.threads);try{for(i.s();!(n=i.n()).done;){var r=n.value,a=new s.Thread(r,e);this._threads.push(a)}}catch(t){i.e(t)}finally{i.f()}this._threadCounter=parseInt(t.threadCounter),this._startOfRoot=$.StartOf(e.rootContentContainer)}},{key:"WriteJson",value:function(t){var i=this;t.WriteObject(function(t){t.WritePropertyStart("threads"),t.WriteArrayStart();var e,n=W(i._threads);try{for(n.s();!(e=n.n()).done;)e.value.WriteJson(t)}catch(t){n.e(t)}finally{n.f()}t.WriteArrayEnd(),t.WritePropertyEnd(),t.WritePropertyStart("threadCounter"),t.WriteInt(i._threadCounter),t.WritePropertyEnd()})}},{key:"PushThread",value:function(){var t=this.currentThread.Copy();this._threadCounter++,t.threadIndex=this._threadCounter,this._threads.push(t)}},{key:"ForkThread",value:function(){var t=this.currentThread.Copy();return this._threadCounter++,t.threadIndex=this._threadCounter,t}},{key:"PopThread",value:function(){if(!this.canPopThread)throw new Error("Can't pop thread");this._threads.splice(this._threads.indexOf(this.currentThread),1)}},{key:"canPopThread",get:function(){return 1<this._threads.length&&!this.elementIsEvaluateFromGame}},{key:"elementIsEvaluateFromGame",get:function(){return this.currentElement.type==H.FunctionEvaluationFromGame}},{key:"Push",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,t=new s.Element(t,this.currentElement.currentPointer,!1);t.evaluationStackHeightWhenPushed=e,t.functionStartInOutputStream=n,this.callStack.push(t)}},{key:"CanPop",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null;return!!this.canPop&&(null==t||this.currentElement.type==t)}},{key:"Pop",value:function(){if(!this.CanPop(0<arguments.length&&void 0!==arguments[0]?arguments[0]:null))throw new Error("Mismatched push/pop in Callstack");this.callStack.pop()}},{key:"GetTemporaryVariableWithName",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:-1;-1==e&&(e=this.currentElementIndex+1);t=E(this.callStack[e-1].temporaryVariables,t,null);return t.exists?t.result:null}},{key:"SetTemporaryVariable",value:function(t,e,n){var i=3<arguments.length&&void 0!==arguments[3]?arguments[3]:-1;-1==i&&(i=this.currentElementIndex+1);i=this.callStack[i-1];if(!n&&!i.temporaryVariables.get(t))throw new Error("Could not find temporary variable to set: "+t);n=E(i.temporaryVariables,t,null);n.exists&&K.RetainListOriginsForAssignment(n.result,e),i.temporaryVariables.set(t,e)}},{key:"ContextForVariableNamed",value:function(t){return this.currentElement.temporaryVariables.get(t)?this.currentElementIndex+1:0}},{key:"ThreadWithIndex",value:function(e){var t=this._threads.filter(function(t){if(t.threadIndex==e)return t});return 0<t.length?t[0]:null}},{key:"callStack",get:function(){return this.currentThread.callstack}},{key:"callStackTrace",get:function(){for(var t=new j,e=0;e<this._threads.length;e++){var n=this._threads[e],i=e==this._threads.length-1;t.AppendFormat("=== THREAD {0}/{1} {2}===\n",e+1,this._threads.length,i?"(current) ":"");for(var r=0;r<n.callstack.length;r++){n.callstack[r].type==H.Function?t.Append("  [FUNCTION] "):t.Append("  [TUNNEL] ");var a=n.callstack[r].currentPointer;if(!a.isNull){if(t.Append("<SOMEWHERE IN "),null===a.container)return R("pointer.container");t.Append(a.container.path.toString()),t.AppendLine(">")}}}return t.toString()}}]),s}();pt=lt=lt||{},ut=function(){function i(t,e){var n=2<arguments.length&&void 0!==arguments[2]&&arguments[2];d(this,i),this.evaluationStackHeightWhenPushed=0,this.functionStartInOutputStream=0,this.currentPointer=e.copy(),this.inExpressionEvaluation=n,this.temporaryVariables=new Map,this.type=t}return o(i,[{key:"Copy",value:function(){var t=new i(this.type,this.currentPointer,this.inExpressionEvaluation);return t.temporaryVariables=new Map(this.temporaryVariables),t.evaluationStackHeightWhenPushed=this.evaluationStackHeightWhenPushed,t.functionStartInOutputStream=this.functionStartInOutputStream,t}}]),i}(),pt.Element=ut,pt.Thread=function(){function v(){if(d(this,v),this.threadIndex=0,this.previousPointer=$.Null,this.callstack=[],arguments[0]&&arguments[1]){var t=arguments[0],e=arguments[1];this.threadIndex=parseInt(t.threadIndex);var n,i=W(t.callstack);try{for(i.s();!(n=i.n()).done;){var r=n.value,a=parseInt(r.type),s=$.Null,o=r.cPath;if(void 0!==o){var u=o.toString(),l=e.ContentAtPath(new C(u));if(s.container=l.container,s.index=parseInt(r.idx),null==l.obj)throw new Error("When loading state, internal story location couldn't be found: "+u+". Has the story changed since this save data was created?");if(l.approximate){if(null===s.container)return R("pointer.container");e.Warning("When loading state, exact internal story location couldn't be found: '"+u+"', so it was approximated to '"+s.container.path.toString()+"' to recover. Has the story changed since this save data was created?")}}var h=!!r.exp,c=new ut(a,s,h),f=r.temp;void 0!==f?c.temporaryVariables=ot.JObjectToDictionaryRuntimeObjs(f):c.temporaryVariables.clear(),this.callstack.push(c)}}catch(t){i.e(t)}finally{i.f()}t=t.previousContentObject;void 0!==t&&(t=new C(t.toString()),this.previousPointer=e.PointerAtPath(t))}}return o(v,[{key:"Copy",value:function(){var t=new v;t.threadIndex=this.threadIndex;var e,n=W(this.callstack);try{for(n.s();!(e=n.n()).done;){var i=e.value;t.callstack.push(i.Copy())}}catch(t){n.e(t)}finally{n.f()}return t.previousPointer=this.previousPointer.copy(),t}},{key:"WriteJson",value:function(t){t.WriteObjectStart(),t.WritePropertyStart("callstack"),t.WriteArrayStart();var e,n=W(this.callstack);try{for(n.s();!(e=n.n()).done;){var i=e.value;if(t.WriteObjectStart(),!i.currentPointer.isNull){if(null===i.currentPointer.container)return R("el.currentPointer.container");t.WriteProperty("cPath",i.currentPointer.container.path.componentsString),t.WriteIntProperty("idx",i.currentPointer.index)}t.WriteProperty("exp",i.inExpressionEvaluation),t.WriteIntProperty("type",i.type),0<i.temporaryVariables.size&&(t.WritePropertyStart("temp"),ot.WriteDictionaryRuntimeObjs(t,i.temporaryVariables),t.WritePropertyEnd()),t.WriteObjectEnd()}}catch(t){n.e(t)}finally{n.f()}if(t.WriteArrayEnd(),t.WritePropertyEnd(),t.WriteIntProperty("threadIndex",this.threadIndex),!this.previousPointer.isNull){var r=this.previousPointer.Resolve();if(null===r)return R("this.previousPointer.Resolve()");t.WriteProperty("previousContentObject",r.path.toString())}t.WriteObjectEnd()}}]),v}();var ht=function(){function l(t,e){d(this,l),this.variableChangedEventCallbacks=[],this.patch=null,this._batchObservingVariableChanges=!1,this._defaultGlobalVariables=new Map,this._changedVariablesForBatchObs=new Set,this._globalVariables=new Map,this._callStack=t,this._listDefsOrigin=e;try{return new Proxy(this,{get:function(t,e){return e in t?t[e]:t.$(e)},set:function(t,e,n){return e in t?t[e]=n:t.$(e,n),!0}})}catch(t){}}return o(l,[{key:"variableChangedEvent",value:function(t,e){var n,i=W(this.variableChangedEventCallbacks);try{for(i.s();!(n=i.n()).done;)(0,n.value)(t,e)}catch(t){i.e(t)}finally{i.f()}}},{key:"batchObservingVariableChanges",get:function(){return this._batchObservingVariableChanges},set:function(t){if(this._batchObservingVariableChanges=t)this._changedVariablesForBatchObs=new Set;else if(null!=this._changedVariablesForBatchObs){var e,n=W(this._changedVariablesForBatchObs);try{for(n.s();!(e=n.n()).done;){var i=e.value,r=this._globalVariables.get(i);r?this.variableChangedEvent(i,r):R("currentValue")}}catch(t){n.e(t)}finally{n.f()}this._changedVariablesForBatchObs=null}}},{key:"callStack",get:function(){return this._callStack},set:function(t){this._callStack=t}},{key:"$",value:function(t,e){if(void 0===e){var n=null;return null!==this.patch&&(n=this.patch.TryGetGlobal(t,null)).exists?n.result.valueObject:void 0!==(n=void 0===(n=this._globalVariables.get(t))?this._defaultGlobalVariables.get(t):n)?n.valueObject:null}if(void 0===this._defaultGlobalVariables.get(t))throw new G("Cannot assign to a variable ("+t+") that hasn't been declared in the story");n=M.Create(e);if(null==n)throw null==e?new Error("Cannot pass null to VariableState"):new Error("Invalid value passed to VariableState: "+e.toString());this.SetGlobal(t,n)}},{key:"ApplyPatch",value:function(){if(null===this.patch)return R("this.patch");var t,e=W(this.patch.globals);try{for(e.s();!(t=e.n()).done;){var n=S(t.value,2),i=n[0],r=n[1];this._globalVariables.set(i,r)}}catch(t){e.e(t)}finally{e.f()}if(null!==this._changedVariablesForBatchObs){var a,s=W(this.patch.changedVariables);try{for(s.s();!(a=s.n()).done;){var o=a.value;this._changedVariablesForBatchObs.add(o)}}catch(t){s.e(t)}finally{s.f()}}this.patch=null}},{key:"SetJsonToken",value:function(t){this._globalVariables.clear();var e,n=W(this._defaultGlobalVariables);try{for(n.s();!(e=n.n()).done;){var i=S(e.value,2),r=i[0],a=i[1],s=t[r];if(void 0!==s){var o=ot.JTokenToRuntimeObject(s);if(null===o)return R("tokenInkObject");this._globalVariables.set(r,o)}else this._globalVariables.set(r,a)}}catch(t){n.e(t)}finally{n.f()}}},{key:"WriteJson",value:function(t){t.WriteObjectStart();var e,n=W(this._globalVariables);try{for(n.s();!(e=n.n()).done;){var i=S(e.value,2),r=i[0],a=i[1],s=r,o=a;if(l.dontSaveDefaultValues&&this._defaultGlobalVariables.has(s)){var u=this._defaultGlobalVariables.get(s);if(this.RuntimeObjectsEqual(o,u))continue}t.WritePropertyStart(s),ot.WriteRuntimeObject(t,o),t.WritePropertyEnd()}}catch(t){n.e(t)}finally{n.f()}t.WriteObjectEnd()}},{key:"RuntimeObjectsEqual",value:function(t,e){if(null===t)return R("obj1");if(null===e)return R("obj2");if(t.constructor!==e.constructor)return!1;var n=V(t,N);if(null!==n)return n.value===L(e,N).value;n=V(t,J);if(null!==n)return n.value===L(e,J).value;n=V(t,A);if(null!==n)return n.value===L(e,A).value;n=V(t,M),e=V(e,M);if(null!==n&&null!==e)return w(n.valueObject)&&w(e.valueObject)?n.valueObject.Equals(e.valueObject):n.valueObject===e.valueObject;throw new Error("FastRoughDefinitelyEquals: Unsupported runtime object type: "+t.constructor.name)}},{key:"GetVariableWithName",value:function(t){var e=this.GetRawVariableWithName(t,1<arguments.length&&void 0!==arguments[1]?arguments[1]:-1),t=V(e,I);return e=null!==t?this.ValueAtVariablePointer(t):e}},{key:"TryGetDefaultVariableValue",value:function(t){t=E(this._defaultGlobalVariables,t,null);return t.exists?t.result:null}},{key:"GlobalVariableExistsWithName",value:function(t){return this._globalVariables.has(t)||null!==this._defaultGlobalVariables&&this._defaultGlobalVariables.has(t)}},{key:"GetRawVariableWithName",value:function(t,e){if(0==e||-1==e){var n=null;if(null!==this.patch&&(n=this.patch.TryGetGlobal(t,null)).exists)return n.result;if((n=E(this._globalVariables,t,null)).exists)return n.result;if(null!==this._defaultGlobalVariables&&(n=E(this._defaultGlobalVariables,t,null)).exists)return n.result;if(null===this._listDefsOrigin)return R("VariablesState._listDefsOrigin");n=this._listDefsOrigin.FindSingleItemListWithName(t);if(n)return n}return this._callStack.GetTemporaryVariableWithName(t,e)}},{key:"ValueAtVariablePointer",value:function(t){return this.GetVariableWithName(t.variableName,t.contextIndex)}},{key:"Assign",value:function(t,e){var n=t.variableName;if(null===n)return R("name");var i=-1,r=!1,r=t.isNewDeclaration?t.isGlobal:this.GlobalVariableExistsWithName(n);if(t.isNewDeclaration){var a=V(e,I);null!==a&&(e=this.ResolveVariablePointer(a))}else for(var s;null!=(s=V(this.GetRawVariableWithName(n,i),I))&&(n=s.variableName,r=0==(i=s.contextIndex)),null!=s;);r?this.SetGlobal(n,e):this._callStack.SetTemporaryVariable(n,e,t.isNewDeclaration,i)}},{key:"SnapshotDefaultGlobals",value:function(){this._defaultGlobalVariables=new Map(this._globalVariables)}},{key:"RetainListOriginsForAssignment",value:function(t,e){t=L(t,K),e=L(e,K);t.value&&e.value&&0==e.value.Count&&e.value.SetInitialOriginNames(t.value.originNames)}},{key:"SetGlobal",value:function(t,e){var n=null;if(null===this.patch&&(n=E(this._globalVariables,t,null)),null!==this.patch&&((n=this.patch.TryGetGlobal(t,null)).exists||(n=E(this._globalVariables,t,null))),K.RetainListOriginsForAssignment(n.result,e),null===t)return R("variableName");if(null!==this.patch?this.patch.SetGlobal(t,e):this._globalVariables.set(t,e),null!==this.variableChangedEvent&&null!==n&&e!==n.result)if(this.batchObservingVariableChanges){if(null===this._changedVariablesForBatchObs)return R("this._changedVariablesForBatchObs");null!==this.patch?this.patch.AddChangedVariable(t):null!==this._changedVariablesForBatchObs&&this._changedVariablesForBatchObs.add(t)}else this.variableChangedEvent(t,e)}},{key:"ResolveVariablePointer",value:function(t){var e=t.contextIndex;-1==e&&(e=this.GetContextIndexOfVariableNamed(t.variableName));var n=V(this.GetRawVariableWithName(t.variableName,e),I);return null!=n?n:new I(t.variableName,e)}},{key:"GetContextIndexOfVariableNamed",value:function(t){return this.GlobalVariableExistsWithName(t)?0:this._callStack.currentElementIndex}},{key:"ObserveVariableChange",value:function(t){this.variableChangedEventCallbacks.push(t)}}]),l}();ht.dontSaveDefaultValues=!0;var ct=function(){function e(t){d(this,e),this.seed=t%2147483647,this.seed<=0&&(this.seed+=2147483646)}return o(e,[{key:"next",value:function(){return this.seed=16807*this.seed%2147483647}},{key:"nextFloat",value:function(){return(this.next()-1)/2147483646}}]),e}(),ft=function(){function e(){var t;d(this,e),this._changedVariables=new Set,this._visitCounts=new Map,this._turnIndices=new Map,1===arguments.length&&null!==arguments[0]?(t=arguments[0],this._globals=new Map(t._globals),this._changedVariables=new Set(t._changedVariables),this._visitCounts=new Map(t._visitCounts),this._turnIndices=new Map(t._turnIndices)):(this._globals=new Map,this._changedVariables=new Set,this._visitCounts=new Map,this._turnIndices=new Map)}return o(e,[{key:"globals",get:function(){return this._globals}},{key:"changedVariables",get:function(){return this._changedVariables}},{key:"visitCounts",get:function(){return this._visitCounts}},{key:"turnIndices",get:function(){return this._turnIndices}},{key:"TryGetGlobal",value:function(t,e){return null!==t&&this._globals.has(t)?{result:this._globals.get(t),exists:!0}:{result:e,exists:!1}}},{key:"SetGlobal",value:function(t,e){this._globals.set(t,e)}},{key:"AddChangedVariable",value:function(t){return this._changedVariables.add(t)}},{key:"TryGetVisitCount",value:function(t,e){return this._visitCounts.has(t)?{result:this._visitCounts.get(t),exists:!0}:{result:e,exists:!1}}},{key:"SetVisitCount",value:function(t,e){this._visitCounts.set(t,e)}},{key:"SetTurnIndex",value:function(t,e){this._turnIndices.set(t,e)}},{key:"TryGetTurnIndex",value:function(t,e){return this._turnIndices.has(t)?{result:this._turnIndices.get(t),exists:!0}:{result:e,exists:!1}}}]),e}(),vt=function(){function e(){d(this,e)}return o(e,null,[{key:"TextToDictionary",value:function(t){return new e.Reader(t).ToDictionary()}},{key:"TextToArray",value:function(t){return new e.Reader(t).ToArray()}}]),e}();!function(n){n.Reader=function(){function e(t){d(this,e),this._rootObject=JSON.parse(t)}return o(e,[{key:"ToDictionary",value:function(){return this._rootObject}},{key:"ToArray",value:function(){return this._rootObject}}]),e}();var t,e=function(){function t(){d(this,t),this._currentPropertyName=null,this._currentString=null,this._stateStack=[],this._collectionStack=[],this._propertyNameStack=[],this._jsonObject=null}return o(t,[{key:"WriteObject",value:function(t){this.WriteObjectStart(),t(this),this.WriteObjectEnd()}},{key:"WriteObjectStart",value:function(){this.StartNewObject(!0);var t,e={};this.state===n.Writer.State.Property?(this.Assert(null!==this.currentCollection),this.Assert(null!==this.currentPropertyName),t=this._propertyNameStack.pop(),this.currentCollection[t]=e):this.state===n.Writer.State.Array?(this.Assert(null!==this.currentCollection),this.currentCollection.push(e)):(this.Assert(this.state===n.Writer.State.None),this._jsonObject=e),this._collectionStack.push(e),this._stateStack.push(new n.Writer.StateElement(n.Writer.State.Object))}},{key:"WriteObjectEnd",value:function(){this.Assert(this.state===n.Writer.State.Object),this._collectionStack.pop(),this._stateStack.pop()}},{key:"WriteProperty",value:function(t,e){this.WritePropertyStart(t),e instanceof Function?e(this):this.Write(e),this.WritePropertyEnd()}},{key:"WriteIntProperty",value:function(t,e){this.WritePropertyStart(t),this.WriteInt(e),this.WritePropertyEnd()}},{key:"WriteFloatProperty",value:function(t,e){this.WritePropertyStart(t),this.WriteFloat(e),this.WritePropertyEnd()}},{key:"WritePropertyStart",value:function(t){this.Assert(this.state===n.Writer.State.Object),this._propertyNameStack.push(t),this.IncrementChildCount(),this._stateStack.push(new n.Writer.StateElement(n.Writer.State.Property))}},{key:"WritePropertyEnd",value:function(){this.Assert(this.state===n.Writer.State.Property),this.Assert(1===this.childCount),this._stateStack.pop()}},{key:"WritePropertyNameStart",value:function(){this.Assert(this.state===n.Writer.State.Object),this.IncrementChildCount(),this._currentPropertyName="",this._stateStack.push(new n.Writer.StateElement(n.Writer.State.Property)),this._stateStack.push(new n.Writer.StateElement(n.Writer.State.PropertyName))}},{key:"WritePropertyNameEnd",value:function(){this.Assert(this.state===n.Writer.State.PropertyName),this.Assert(null!==this._currentPropertyName),this._propertyNameStack.push(this._currentPropertyName),this._currentPropertyName=null,this._stateStack.pop()}},{key:"WritePropertyNameInner",value:function(t){this.Assert(this.state===n.Writer.State.PropertyName),this.Assert(null!==this._currentPropertyName),this._currentPropertyName+=t}},{key:"WriteArrayStart",value:function(){this.StartNewObject(!0);var t,e=[];this.state===n.Writer.State.Property?(this.Assert(null!==this.currentCollection),this.Assert(null!==this.currentPropertyName),t=this._propertyNameStack.pop(),this.currentCollection[t]=e):this.state===n.Writer.State.Array?(this.Assert(null!==this.currentCollection),this.currentCollection.push(e)):(this.Assert(this.state===n.Writer.State.None),this._jsonObject=e),this._collectionStack.push(e),this._stateStack.push(new n.Writer.StateElement(n.Writer.State.Array))}},{key:"WriteArrayEnd",value:function(){this.Assert(this.state===n.Writer.State.Array),this._collectionStack.pop(),this._stateStack.pop()}},{key:"Write",value:function(t){null!==t?(this.StartNewObject(!1),this._addToCurrentObject(t)):console.error("Warning: trying to write a null string")}},{key:"WriteBool",value:function(t){null!==t&&(this.StartNewObject(!1),this._addToCurrentObject(t))}},{key:"WriteInt",value:function(t){null!==t&&(this.StartNewObject(!1),this._addToCurrentObject(Math.floor(t)))}},{key:"WriteFloat",value:function(t){null!==t&&(this.StartNewObject(!1),t==Number.POSITIVE_INFINITY?this._addToCurrentObject(34e37):t==Number.NEGATIVE_INFINITY?this._addToCurrentObject(-34e37):isNaN(t)?this._addToCurrentObject(0):this._addToCurrentObject(t))}},{key:"WriteNull",value:function(){this.StartNewObject(!1),this._addToCurrentObject(null)}},{key:"WriteStringStart",value:function(){this.StartNewObject(!1),this._currentString="",this._stateStack.push(new n.Writer.StateElement(n.Writer.State.String))}},{key:"WriteStringEnd",value:function(){this.Assert(this.state==n.Writer.State.String),this._stateStack.pop(),this._addToCurrentObject(this._currentString),this._currentString=null}},{key:"WriteStringInner",value:function(t){this.Assert(this.state===n.Writer.State.String),null!==t?this._currentString+=t:console.error("Warning: trying to write a null string")}},{key:"ToString",value:function(){return null===this._jsonObject?"":JSON.stringify(this._jsonObject)}},{key:"StartNewObject",value:function(t){t?this.Assert(this.state===n.Writer.State.None||this.state===n.Writer.State.Property||this.state===n.Writer.State.Array):this.Assert(this.state===n.Writer.State.Property||this.state===n.Writer.State.Array),this.state===n.Writer.State.Property&&this.Assert(0===this.childCount),this.state!==n.Writer.State.Array&&this.state!==n.Writer.State.Property||this.IncrementChildCount()}},{key:"state",get:function(){return 0<this._stateStack.length?this._stateStack[this._stateStack.length-1].type:n.Writer.State.None}},{key:"childCount",get:function(){return 0<this._stateStack.length?this._stateStack[this._stateStack.length-1].childCount:0}},{key:"currentCollection",get:function(){return 0<this._collectionStack.length?this._collectionStack[this._collectionStack.length-1]:null}},{key:"currentPropertyName",get:function(){return 0<this._propertyNameStack.length?this._propertyNameStack[this._propertyNameStack.length-1]:null}},{key:"IncrementChildCount",value:function(){this.Assert(0<this._stateStack.length);var t=this._stateStack.pop();t.childCount++,this._stateStack.push(t)}},{key:"Assert",value:function(t){if(!t)throw Error("Assert failed while writing JSON")}},{key:"_addToCurrentObject",value:function(t){this.Assert(null!==this.currentCollection),this.state===n.Writer.State.Array?(this.Assert(Array.isArray(this.currentCollection)),this.currentCollection.push(t)):this.state===n.Writer.State.Property&&(this.Assert(!Array.isArray(this.currentCollection)),this.Assert(null!==this.currentPropertyName),this.currentCollection[this.currentPropertyName]=t,this._propertyNameStack.pop())}}]),t}();n.Writer=e,t=e=n.Writer||(n.Writer={}),(e=t.State||(t.State={}))[e.None=0]="None",e[e.Object=1]="Object",e[e.Array=2]="Array",e[e.Property=3]="Property",e[e.PropertyName=4]="PropertyName",e[e.String=5]="String",t.StateElement=function t(e){d(this,t),this.type=n.Writer.State.None,this.childCount=0,this.type=e}}(vt=vt||{});var dt,pt,yt=function(){function n(){d(this,n);var t=arguments[0],e=arguments[1];this.name=t,this.callStack=new lt(e),arguments[2]?(this.callStack.SetJsonToken((t=arguments[2]).callstack,e),this.outputStream=ot.JArrayToRuntimeObjList(t.outputStream),this.currentChoices=ot.JArrayToRuntimeObjList(t.currentChoices),void 0!==(t=t.choiceThreads)&&this.LoadFlowChoiceThreads(t,e)):(this.outputStream=[],this.currentChoices=[])}return o(n,[{key:"WriteJson",value:function(t){var r=this;t.WriteObjectStart(),t.WriteProperty("callstack",function(t){return r.callStack.WriteJson(t)}),t.WriteProperty("outputStream",function(t){return ot.WriteListRuntimeObjs(t,r.outputStream)});var e,n=!1,i=W(this.currentChoices);try{for(i.s();!(e=i.n()).done;){var a=e.value;if(null===a.threadAtGeneration)return R("c.threadAtGeneration");a.originalThreadIndex=a.threadAtGeneration.threadIndex,null===this.callStack.ThreadWithIndex(a.originalThreadIndex)&&(n||(n=!0,t.WritePropertyStart("choiceThreads"),t.WriteObjectStart()),t.WritePropertyStart(a.originalThreadIndex),a.threadAtGeneration.WriteJson(t),t.WritePropertyEnd())}}catch(t){i.e(t)}finally{i.f()}n&&(t.WriteObjectEnd(),t.WritePropertyEnd()),t.WriteProperty("currentChoices",function(t){t.WriteArrayStart();var e,n=W(r.currentChoices);try{for(n.s();!(e=n.n()).done;){var i=e.value;ot.WriteChoice(t,i)}}catch(t){n.e(t)}finally{n.f()}t.WriteArrayEnd()}),t.WriteObjectEnd()}},{key:"LoadFlowChoiceThreads",value:function(t,e){var n,i=W(this.currentChoices);try{for(i.s();!(n=i.n()).done;){var r,a=n.value,s=this.callStack.ThreadWithIndex(a.originalThreadIndex);null!==s?a.threadAtGeneration=s.Copy():(r=t["".concat(a.originalThreadIndex)],a.threadAtGeneration=new lt.Thread(r,e))}}catch(t){i.e(t)}finally{i.f()}}}]),n}(),mt=function(){function u(t){d(this,u),this.kInkSaveStateVersion=9,this.kMinCompatibleLoadVersion=8,this.onDidLoadState=null,this._currentErrors=null,this._currentWarnings=null,this.divertedPointer=$.Null,this._currentTurnIndex=0,this.storySeed=0,this.previousRandom=0,this.didSafeExit=!1,this._currentText=null,this._currentTags=null,this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0,this._patch=null,this._namedFlows=null,this.kDefaultFlowName="DEFAULT_FLOW",this.story=t,this._currentFlow=new yt(this.kDefaultFlowName,t),this.OutputStreamDirty(),this._evaluationStack=[],this._variablesState=new ht(this.callStack,t.listDefinitions),this._visitCounts=new Map,this._turnIndices=new Map,this.currentTurnIndex=-1;t=(new Date).getTime();this.storySeed=new ct(t).next()%100,this.previousRandom=0,this.GoToStart()}return o(u,[{key:"ToJson",value:function(){var t=new vt.Writer;return this.WriteJson(t),t.ToString()}},{key:"toJson",value:function(){return this.ToJson(0<arguments.length&&void 0!==arguments[0]&&arguments[0])}},{key:"LoadJson",value:function(t){t=vt.TextToDictionary(t);this.LoadJsonObj(t),null!==this.onDidLoadState&&this.onDidLoadState()}},{key:"VisitCountAtPathString",value:function(t){if(null!==this._patch){var e=this.story.ContentAtPath(new C(t)).container;if(null===e)throw new Error("Content at path not found: "+t);if((e=this._patch.TryGetVisitCount(e,0)).exists)return e.result}return(e=E(this._visitCounts,t,null)).exists?e.result:0}},{key:"VisitCountForContainer",value:function(t){if(null===t)return R("container");if(!t.visitsShouldBeCounted)return this.story.Error("Read count for target ("+t.name+" - on "+t.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c)."),0;if(null!==this._patch){var e=this._patch.TryGetVisitCount(t,0);if(e.exists)return e.result}t=t.path.toString(),t=E(this._visitCounts,t,null);return t.exists?t.result:0}},{key:"IncrementVisitCountForContainer",value:function(t){var e,n;null===this._patch?(n=t.path.toString(),(e=E(this._visitCounts,n,null)).exists?this._visitCounts.set(n,e.result+1):this._visitCounts.set(n,1)):(n=this.VisitCountForContainer(t),this._patch.SetVisitCount(t,++n))}},{key:"RecordTurnIndexVisitToContainer",value:function(t){var e;null===this._patch?(e=t.path.toString(),this._turnIndices.set(e,this.currentTurnIndex)):this._patch.SetTurnIndex(t,this.currentTurnIndex)}},{key:"TurnsSinceForContainer",value:function(t){if(t.turnIndexShouldBeCounted||this.story.Error("TURNS_SINCE() for target ("+t.name+" - on "+t.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c)."),null!==this._patch){var e=this._patch.TryGetTurnIndex(t,0);if(e.exists)return this.currentTurnIndex-e.result}t=t.path.toString(),t=E(this._turnIndices,t,0);return t.exists?this.currentTurnIndex-t.result:-1}},{key:"callstackDepth",get:function(){return this.callStack.depth}},{key:"outputStream",get:function(){return this._currentFlow.outputStream}},{key:"currentChoices",get:function(){return this.canContinue?[]:this._currentFlow.currentChoices}},{key:"generatedChoices",get:function(){return this._currentFlow.currentChoices}},{key:"currentErrors",get:function(){return this._currentErrors}},{key:"currentWarnings",get:function(){return this._currentWarnings}},{key:"variablesState",get:function(){return this._variablesState},set:function(t){this._variablesState=t}},{key:"callStack",get:function(){return this._currentFlow.callStack}},{key:"evaluationStack",get:function(){return this._evaluationStack}},{key:"currentTurnIndex",get:function(){return this._currentTurnIndex},set:function(t){this._currentTurnIndex=t}},{key:"currentPathString",get:function(){var t=this.currentPointer;return t.isNull?null:null===t.path?R("pointer.path"):t.path.toString()}},{key:"currentPointer",get:function(){return this.callStack.currentElement.currentPointer.copy()},set:function(t){this.callStack.currentElement.currentPointer=t.copy()}},{key:"previousPointer",get:function(){return this.callStack.currentThread.previousPointer.copy()},set:function(t){this.callStack.currentThread.previousPointer=t.copy()}},{key:"canContinue",get:function(){return!this.currentPointer.isNull&&!this.hasError}},{key:"hasError",get:function(){return null!=this.currentErrors&&0<this.currentErrors.length}},{key:"hasWarning",get:function(){return null!=this.currentWarnings&&0<this.currentWarnings.length}},{key:"currentText",get:function(){if(this._outputStreamTextDirty){var t,e=new j,n=W(this.outputStream);try{for(n.s();!(t=n.n()).done;){var i=V(t.value,U);null!==i&&e.Append(i.value)}}catch(t){n.e(t)}finally{n.f()}this._currentText=this.CleanOutputWhitespace(e.toString()),this._outputStreamTextDirty=!1}return this._currentText}},{key:"CleanOutputWhitespace",value:function(t){for(var e=new j,n=-1,i=0,r=0;r<t.length;r++){var a=t.charAt(r),s=" "==a||"\t"==a;s&&-1==n&&(n=r),s||("\n"!=a&&0<n&&n!=i&&e.Append(" "),n=-1),"\n"==a&&(i=r+1),s||e.Append(a)}return e.toString()}},{key:"currentTags",get:function(){if(this._outputStreamTagsDirty){this._currentTags=[];var t,e=W(this.outputStream);try{for(e.s();!(t=e.n()).done;){var n=V(t.value,it);null!==n&&this._currentTags.push(n.text)}}catch(t){e.e(t)}finally{e.f()}this._outputStreamTagsDirty=!1}return this._currentTags}},{key:"currentFlowName",get:function(){return this._currentFlow.name}},{key:"inExpressionEvaluation",get:function(){return this.callStack.currentElement.inExpressionEvaluation},set:function(t){this.callStack.currentElement.inExpressionEvaluation=t}},{key:"GoToStart",value:function(){this.callStack.currentElement.currentPointer=$.StartOf(this.story.mainContentContainer)}},{key:"SwitchFlow_Internal",value:function(t){if(null===t)throw new Error("Must pass a non-null string to Story.SwitchFlow");var e,n;null===this._namedFlows&&(this._namedFlows=new Map,this._namedFlows.set(this.kDefaultFlowName,this._currentFlow)),t!==this._currentFlow.name&&((n=E(this._namedFlows,t,null)).exists?e=n.result:(e=new yt(t,this.story),this._namedFlows.set(t,e)),this._currentFlow=e,this.variablesState.callStack=this._currentFlow.callStack,this.OutputStreamDirty())}},{key:"SwitchToDefaultFlow_Internal",value:function(){null!==this._namedFlows&&this.SwitchFlow_Internal(this.kDefaultFlowName)}},{key:"RemoveFlow_Internal",value:function(t){if(null===t)throw new Error("Must pass a non-null string to Story.DestroyFlow");if(t===this.kDefaultFlowName)throw new Error("Cannot destroy default flow");if(this._currentFlow.name===t&&this.SwitchToDefaultFlow_Internal(),null===this._namedFlows)return R("this._namedFlows");this._namedFlows.delete(t)}},{key:"CopyAndStartPatching",value:function(){var t,e,n=new u(this.story);if(n._patch=new ft(this._patch),n._currentFlow.name=this._currentFlow.name,n._currentFlow.callStack=new lt(this._currentFlow.callStack),(t=n._currentFlow.currentChoices).push.apply(t,p(this._currentFlow.currentChoices)),(t=n._currentFlow.outputStream).push.apply(t,p(this._currentFlow.outputStream)),n.OutputStreamDirty(),null!==this._namedFlows){n._namedFlows=new Map;var i,r=W(this._namedFlows);try{for(r.s();!(i=r.n()).done;){var a=S(i.value,2),s=a[0],o=a[1];n._namedFlows.set(s,o)}}catch(t){r.e(t)}finally{r.f()}n._namedFlows.set(this._currentFlow.name,n._currentFlow)}return this.hasError&&(n._currentErrors=[],(t=n._currentErrors).push.apply(t,p(this.currentErrors||[]))),this.hasWarning&&(n._currentWarnings=[],(e=n._currentWarnings).push.apply(e,p(this.currentWarnings||[]))),n.variablesState=this.variablesState,n.variablesState.callStack=n.callStack,n.variablesState.patch=n._patch,(e=n.evaluationStack).push.apply(e,p(this.evaluationStack)),this.divertedPointer.isNull||(n.divertedPointer=this.divertedPointer.copy()),n.previousPointer=this.previousPointer.copy(),n._visitCounts=this._visitCounts,n._turnIndices=this._turnIndices,n.currentTurnIndex=this.currentTurnIndex,n.storySeed=this.storySeed,n.previousRandom=this.previousRandom,n.didSafeExit=this.didSafeExit,n}},{key:"RestoreAfterPatch",value:function(){this.variablesState.callStack=this.callStack,this.variablesState.patch=this._patch}},{key:"ApplyAnyPatch",value:function(){if(null!==this._patch){this.variablesState.ApplyPatch();var t,e=W(this._patch.visitCounts);try{for(e.s();!(t=e.n()).done;){var n=S(t.value,2),i=n[0],r=n[1];this.ApplyCountChanges(i,r,!0)}}catch(t){e.e(t)}finally{e.f()}var a,s=W(this._patch.turnIndices);try{for(s.s();!(a=s.n()).done;){var o=S(a.value,2),u=o[0],l=o[1];this.ApplyCountChanges(u,l,!1)}}catch(t){s.e(t)}finally{s.f()}this._patch=null}}},{key:"ApplyCountChanges",value:function(t,e,n){(n?this._visitCounts:this._turnIndices).set(t.path.toString(),e)}},{key:"WriteJson",value:function(i){var e=this;if(i.WriteObjectStart(),i.WritePropertyStart("flows"),i.WriteObjectStart(),null!==this._namedFlows){var r,n=W(this._namedFlows);try{for(n.s();!(r=n.n()).done;)!function(){var t=S(r.value,2),e=t[0],n=t[1];i.WriteProperty(e,function(t){return n.WriteJson(t)})}()}catch(t){n.e(t)}finally{n.f()}}else i.WriteProperty(this._currentFlow.name,function(t){return e._currentFlow.WriteJson(t)});if(i.WriteObjectEnd(),i.WritePropertyEnd(),i.WriteProperty("currentFlowName",this._currentFlow.name),i.WriteProperty("variablesState",function(t){return e.variablesState.WriteJson(t)}),i.WriteProperty("evalStack",function(t){return ot.WriteListRuntimeObjs(t,e.evaluationStack)}),!this.divertedPointer.isNull){if(null===this.divertedPointer.path)return R("divertedPointer");i.WriteProperty("currentDivertTarget",this.divertedPointer.path.componentsString)}i.WriteProperty("visitCounts",function(t){return ot.WriteIntDictionary(t,e._visitCounts)}),i.WriteProperty("turnIndices",function(t){return ot.WriteIntDictionary(t,e._turnIndices)}),i.WriteIntProperty("turnIdx",this.currentTurnIndex),i.WriteIntProperty("storySeed",this.storySeed),i.WriteIntProperty("previousRandom",this.previousRandom),i.WriteIntProperty("inkSaveVersion",this.kInkSaveStateVersion),i.WriteIntProperty("inkFormatVersion",a.Story.inkVersionCurrent),i.WriteObjectEnd()}},{key:"LoadJsonObj",value:function(t){var e=t,t=e.inkSaveVersion;if(null==t)throw new Error("ink save format incorrect, can't load.");if(parseInt(t)<this.kMinCompatibleLoadVersion)throw new Error("Ink save format isn't compatible with the current version (saw '"+t+"', but minimum is "+this.kMinCompatibleLoadVersion+"), so can't load.");t=e.flows;if(null!=t){var n=t;1==Object.keys(n).length?this._namedFlows=null:null===this._namedFlows?this._namedFlows=new Map:this._namedFlows.clear();for(var i=0,r=Object.entries(n);i<r.length;i++){var a=S(r[i],2),s=a[0],o=a[1],a=new yt(s,this.story,o);if(1==Object.keys(n).length)this._currentFlow=new yt(s,this.story,o);else{if(null===this._namedFlows)return R("this._namedFlows");this._namedFlows.set(s,a)}}null!=this._namedFlows&&1<this._namedFlows.size&&(t=e.currentFlowName,this._currentFlow=this._namedFlows.get(t))}else{this._namedFlows=null,this._currentFlow.name=this.kDefaultFlowName,this._currentFlow.callStack.SetJsonToken(e.callstackThreads,this.story),this._currentFlow.outputStream=ot.JArrayToRuntimeObjList(e.outputStream),this._currentFlow.currentChoices=ot.JArrayToRuntimeObjList(e.currentChoices);var u=e.choiceThreads;this._currentFlow.LoadFlowChoiceThreads(u,this.story)}this.OutputStreamDirty(),this.variablesState.SetJsonToken(e.variablesState),this.variablesState.callStack=this._currentFlow.callStack,this._evaluationStack=ot.JArrayToRuntimeObjList(e.evalStack);u=e.currentDivertTarget;null!=u&&(u=new C(u.toString()),this.divertedPointer=this.story.PointerAtPath(u)),this._visitCounts=ot.JObjectToIntDictionary(e.visitCounts),this._turnIndices=ot.JObjectToIntDictionary(e.turnIndices),this.currentTurnIndex=parseInt(e.turnIdx),this.storySeed=parseInt(e.storySeed),this.previousRandom=parseInt(e.previousRandom)}},{key:"ResetErrors",value:function(){this._currentErrors=null,this._currentWarnings=null}},{key:"ResetOutput",value:function(){var t,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null;this.outputStream.length=0,null!==e&&(t=this.outputStream).push.apply(t,p(e)),this.OutputStreamDirty()}},{key:"PushToOutputStream",value:function(t){var e=V(t,U);if(null!==e){e=this.TrySplittingHeadTailWhitespace(e);if(null!==e){var n,i=W(e);try{for(i.s();!(n=i.n()).done;){var r=n.value;this.PushToOutputStreamIndividual(r)}}catch(t){i.e(t)}finally{i.f()}return void this.OutputStreamDirty()}}this.PushToOutputStreamIndividual(t),this.OutputStreamDirty()}},{key:"PopFromOutputStream",value:function(t){this.outputStream.splice(this.outputStream.length-t,t),this.OutputStreamDirty()}},{key:"TrySplittingHeadTailWhitespace",value:function(t){var e=t.value;if(null===e)return R("single.value");for(var n=-1,i=-1,r=0;r<e.length;r++){var a=e[r];if("\n"==a)-1==n&&(n=r),i=r;else if(" "!=a&&"\t"!=a)break}for(var s=-1,o=-1,u=e.length-1;0<=u;u--){var l=e[u];if("\n"==l)-1==s&&(s=u),o=u;else if(" "!=l&&"\t"!=l)break}if(-1==n&&-1==s)return null;var h,c=[],f=0,v=e.length;return-1!=n&&(0<n&&(t=new U(e.substring(0,n)),c.push(t)),c.push(new U("\n")),f=i+1),f<(v=-1!=s?o:v)&&(h=e.substring(f,v-f),c.push(new U(h))),-1!=s&&i<o&&(c.push(new U("\n")),s<e.length-1&&(h=e.length-s-1,h=new U(e.substring(s+1,h)),c.push(h))),c}},{key:"PushToOutputStreamIndividual",value:function(t){var e=V(t,F),n=V(t,U),i=!0;if(e)this.TrimNewlinesFromOutputStream(),i=!0;else if(n){var r=-1,e=this.callStack.currentElement;e.type==H.Function&&(r=e.functionStartInOutputStream);for(var a=-1,s=this.outputStream.length-1;0<=s;s--){var o=this.outputStream[s],u=o instanceof X?o:null;if(null!=(o instanceof F?o:null)){a=s;break}if(null!=u&&u.commandType==X.CommandType.BeginString){r<=s&&(r=-1);break}}if(-1!=(-1!=a&&-1!=r?Math.min(r,a):-1!=a?a:r)){if(n.isNewline)i=!1;else if(n.isNonWhitespace&&(-1<a&&this.RemoveExistingGlue(),-1<r))for(var l=this.callStack.elements,h=l.length-1;0<=h;h--){var c=l[h];if(c.type!=H.Function)break;c.functionStartInOutputStream=-1}}else n.isNewline&&(!this.outputStreamEndsInNewline&&this.outputStreamContainsContent||(i=!1))}if(i){if(null===t)return R("obj");this.outputStream.push(t),this.OutputStreamDirty()}}},{key:"TrimNewlinesFromOutputStream",value:function(){for(var t=-1,e=this.outputStream.length-1;0<=e;){var n=this.outputStream[e],i=V(n,X),n=V(n,U);if(null!=i||null!=n&&n.isNonWhitespace)break;null!=n&&n.isNewline&&(t=e),e--}if(0<=t)for(e=t;e<this.outputStream.length;)V(this.outputStream[e],U)?this.outputStream.splice(e,1):e++;this.OutputStreamDirty()}},{key:"RemoveExistingGlue",value:function(){for(var t=this.outputStream.length-1;0<=t;t--){var e=this.outputStream[t];if(e instanceof F)this.outputStream.splice(t,1);else if(e instanceof X)break}this.OutputStreamDirty()}},{key:"outputStreamEndsInNewline",get:function(){if(0<this.outputStream.length)for(var t=this.outputStream.length-1;0<=t;t--){if(this.outputStream[t]instanceof X)break;var e=this.outputStream[t];if(e instanceof U){if(e.isNewline)return!0;if(e.isNonWhitespace)break}}return!1}},{key:"outputStreamContainsContent",get:function(){var t,e=W(this.outputStream);try{for(e.s();!(t=e.n()).done;)if(t.value instanceof U)return!0}catch(t){e.e(t)}finally{e.f()}return!1}},{key:"inStringEvaluation",get:function(){for(var t=this.outputStream.length-1;0<=t;t--){var e=V(this.outputStream[t],X);if(e instanceof X&&e.commandType==X.CommandType.BeginString)return!0}return!1}},{key:"PushEvaluationStack",value:function(t){var e=V(t,K);if(e){var n=e.value;if(null===n)return R("rawList");if(null!=n.originNames){n.origins||(n.origins=[]),n.origins.length=0;var i,r=W(n.originNames);try{for(r.s();!(i=r.n()).done;){var a=i.value;if(null===this.story.listDefinitions)return R("StoryState.story.listDefinitions");var s=this.story.listDefinitions.TryListGetDefinition(a,null);if(null===s.result)return R("StoryState def.result");n.origins.indexOf(s.result)<0&&n.origins.push(s.result)}}catch(t){r.e(t)}finally{r.f()}}}if(null===t)return R("obj");this.evaluationStack.push(t)}},{key:"PopEvaluationStack",value:function(t){if(void 0===t)return e(this.evaluationStack.pop());if(t>this.evaluationStack.length)throw new Error("trying to pop too many objects");return e(this.evaluationStack.splice(this.evaluationStack.length-t,t))}},{key:"PeekEvaluationStack",value:function(){return this.evaluationStack[this.evaluationStack.length-1]}},{key:"ForceEnd",value:function(){this.callStack.Reset(),this._currentFlow.currentChoices.length=0,this.currentPointer=$.Null,this.previousPointer=$.Null,this.didSafeExit=!0}},{key:"TrimWhitespaceFromFunctionEnd",value:function(){k.Assert(this.callStack.currentElement.type==H.Function);var t=this.callStack.currentElement.functionStartInOutputStream;-1==t&&(t=0);for(var e=this.outputStream.length-1;t<=e;e--){var n=this.outputStream[e],i=V(n,U),n=V(n,X);if(null!=i){if(n)break;if(!i.isNewline&&!i.isInlineWhitespace)break;this.outputStream.splice(e,1),this.OutputStreamDirty()}}}},{key:"PopCallStack",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null;this.callStack.currentElement.type==H.Function&&this.TrimWhitespaceFromFunctionEnd(),this.callStack.Pop(t)}},{key:"SetChosenPath",value:function(t,e){this._currentFlow.currentChoices.length=0;t=this.story.PointerAtPath(t);t.isNull||-1!=t.index||(t.index=0),this.currentPointer=t,e&&this.currentTurnIndex++}},{key:"StartFunctionEvaluationFromGame",value:function(t,e){this.callStack.Push(H.FunctionEvaluationFromGame,this.evaluationStack.length),this.callStack.currentElement.currentPointer=$.StartOf(t),this.PassArgumentsToEvaluationStack(e)}},{key:"PassArgumentsToEvaluationStack",value:function(t){if(null!==t)for(var e=0;e<t.length;e++){if("number"!=typeof t[e]&&"string"!=typeof t[e]||t[e]instanceof B)throw new Error("ink arguments when calling EvaluateFunction / ChoosePathStringWithParameters  must be int, float or string");this.PushEvaluationStack(M.Create(t[e]))}}},{key:"TryExitFunctionEvaluationFromGame",value:function(){return this.callStack.currentElement.type==H.FunctionEvaluationFromGame&&(this.currentPointer=$.Null,this.didSafeExit=!0)}},{key:"CompleteFunctionEvaluationFromGame",value:function(){if(this.callStack.currentElement.type!=H.FunctionEvaluationFromGame)throw new Error("Expected external function evaluation to be complete. Stack trace: "+this.callStack.callStackTrace);for(var t=this.callStack.currentElement.evaluationStackHeightWhenPushed,e=null;this.evaluationStack.length>t;){var n=this.PopEvaluationStack();null===e&&(e=n)}if(this.PopCallStack(H.FunctionEvaluationFromGame),e){if(e instanceof et)return null;var i=L(e,M);return i.valueType==P.DivertTarget?i.valueObject.toString():i.valueObject}return null}},{key:"AddError",value:function(t,e){e?(null==this._currentWarnings&&(this._currentWarnings=[]),this._currentWarnings.push(t)):(null==this._currentErrors&&(this._currentErrors=[]),this._currentErrors.push(t))}},{key:"OutputStreamDirty",value:function(){this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0}}]),u}(),gt=function(){function t(){d(this,t),this.startTime=void 0}return o(t,[{key:"ElapsedMilliseconds",get:function(){return void 0===this.startTime?0:(new Date).getTime()-this.startTime}},{key:"Start",value:function(){this.startTime=(new Date).getTime()}},{key:"Stop",value:function(){this.startTime=void 0}}]),t}();(pt=dt=dt||{})[pt.Author=0]="Author",pt[pt.Warning=1]="Warning",pt[pt.Error=2]="Error",Number.isInteger||(Number.isInteger=function(t){return"number"==typeof t&&isFinite(t)&&-9007199254740992<t&&t<9007199254740992&&Math.floor(t)===t}),a.Story=function(){u(f,T);var r=v(f);function f(){var t,e;d(this,f),(t=r.call(this)).inkVersionMinimumCompatible=18,t.onError=null,t.onDidContinue=null,t.onMakeChoice=null,t.onEvaluateFunction=null,t.onCompleteEvaluateFunction=null,t.onChoosePathString=null,t._prevContainers=[],t.allowExternalFunctionFallbacks=!1,t._listDefinitions=null,t._variableObservers=null,t._hasValidatedExternals=!1,t._temporaryEvaluationContainer=null,t._asyncContinueActive=!1,t._stateSnapshotAtLastNewline=null,t._sawLookaheadUnsafeFunctionAfterNewline=!1,t._recursiveContinueCount=0,t._asyncSaving=!1;var n=t._profiler=null,i=null;if(arguments[0]instanceof z?(e=arguments[0],void 0!==arguments[1]&&(n=arguments[1]),t._mainContentContainer=e):i="string"==typeof arguments[0]?vt.TextToDictionary(arguments[0]):arguments[0],null!=n&&(t._listDefinitions=new st(n)),t._externals=new Map,null!==i){n=i,i=n.inkVersion;if(null==i)throw new Error("ink version number not found. Are you sure it's a valid .ink.json file?");i=parseInt(i);if(f.inkVersionCurrent<i)throw new Error("Version of ink used to build story was newer than the current version of the engine");if(i<t.inkVersionMinimumCompatible)throw new Error("Version of ink used to build story is too old to be loaded by this version of the engine");i!=f.inkVersionCurrent&&console.warn("WARNING: Version of ink used to build story doesn't match current version of engine. Non-critical, but recommend synchronising.");i=n.root;if(null==i)throw new Error("Root node for ink not found. Are you sure it's a valid .ink.json file?");(n=n.listDefs)&&(t._listDefinitions=ot.JTokenToListDefinitions(n)),t._mainContentContainer=L(ot.JTokenToRuntimeObject(i),z),t.ResetState()}return t}return o(f,[{key:"currentChoices",get:function(){var t=[];if(null===this._state)return R("this._state");var e,n=W(this._state.currentChoices);try{for(n.s();!(e=n.n()).done;){var i=e.value;i.isInvisibleDefault||(i.index=t.length,t.push(i))}}catch(t){n.e(t)}finally{n.f()}return t}},{key:"currentText",get:function(){return this.IfAsyncWeCant("call currentText since it's a work in progress"),this.state.currentText}},{key:"currentTags",get:function(){return this.IfAsyncWeCant("call currentTags since it's a work in progress"),this.state.currentTags}},{key:"currentErrors",get:function(){return this.state.currentErrors}},{key:"currentWarnings",get:function(){return this.state.currentWarnings}},{key:"currentFlowName",get:function(){return this.state.currentFlowName}},{key:"hasError",get:function(){return this.state.hasError}},{key:"hasWarning",get:function(){return this.state.hasWarning}},{key:"variablesState",get:function(){return this.state.variablesState}},{key:"listDefinitions",get:function(){return this._listDefinitions}},{key:"state",get:function(){return this._state}},{key:"StartProfiling",value:function(){}},{key:"EndProfiling",value:function(){}},{key:"ToJson",value:function(t){var e=this,n=!1;if(t||(n=!0,t=new vt.Writer),t.WriteObjectStart(),t.WriteIntProperty("inkVersion",f.inkVersionCurrent),t.WriteProperty("root",function(t){return ot.WriteRuntimeContainer(t,e._mainContentContainer)}),null!=this._listDefinitions){t.WritePropertyStart("listDefs"),t.WriteObjectStart();var i,r=W(this._listDefinitions.lists);try{for(r.s();!(i=r.n()).done;){var a=i.value;t.WritePropertyStart(a.name),t.WriteObjectStart();var s,o=W(a.items);try{for(o.s();!(s=o.n()).done;){var u=S(s.value,2),l=u[0],h=u[1],c=D.fromSerializedKey(l);t.WriteIntProperty(c.itemName,h)}}catch(t){o.e(t)}finally{o.f()}t.WriteObjectEnd(),t.WritePropertyEnd()}}catch(t){r.e(t)}finally{r.f()}t.WriteObjectEnd(),t.WritePropertyEnd()}if(t.WriteObjectEnd(),n)return t.ToString()}},{key:"ResetState",value:function(){this.IfAsyncWeCant("ResetState"),this._state=new mt(this),this._state.variablesState.ObserveVariableChange(this.VariableStateDidChangeEvent.bind(this)),this.ResetGlobals()}},{key:"ResetErrors",value:function(){if(null===this._state)return R("this._state");this._state.ResetErrors()}},{key:"ResetCallstack",value:function(){if(this.IfAsyncWeCant("ResetCallstack"),null===this._state)return R("this._state");this._state.ForceEnd()}},{key:"ResetGlobals",value:function(){var t;this._mainContentContainer.namedContent.get("global decl")&&(t=this.state.currentPointer.copy(),this.ChoosePath(new C("global decl"),!1),this.ContinueInternal(),this.state.currentPointer=t),this.state.variablesState.SnapshotDefaultGlobals()}},{key:"SwitchFlow",value:function(t){if(this.IfAsyncWeCant("switch flow"),this._asyncSaving)throw new Error("Story is already in background saving mode, can't switch flow to "+t);this.state.SwitchFlow_Internal(t)}},{key:"RemoveFlow",value:function(t){this.state.RemoveFlow_Internal(t)}},{key:"SwitchToDefaultFlow",value:function(){this.state.SwitchToDefaultFlow_Internal()}},{key:"Continue",value:function(){return this.ContinueAsync(0),this.currentText}},{key:"canContinue",get:function(){return this.state.canContinue}},{key:"asyncContinueComplete",get:function(){return!this._asyncContinueActive}},{key:"ContinueAsync",value:function(t){this._hasValidatedExternals||this.ValidateExternalBindings(),this.ContinueInternal(t)}},{key:"ContinueInternal",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0;null!=this._profiler&&this._profiler.PreContinue();var e=0<t;if(this._recursiveContinueCount++,!this._asyncContinueActive){if(this._asyncContinueActive=e,!this.canContinue)throw new Error("Can't continue - should check canContinue before calling Continue");this._state.didSafeExit=!1,this._state.ResetOutput(),1==this._recursiveContinueCount&&(this._state.variablesState.batchObservingVariableChanges=!0)}var n=new gt;n.Start();var i=!1;this._sawLookaheadUnsafeFunctionAfterNewline=!1;do{try{i=this.ContinueSingleStep()}catch(t){if(!(t instanceof G))throw t;this.AddError(t.message,void 0,t.useEndLineNumber);break}}while(!i&&(!(this._asyncContinueActive&&n.ElapsedMilliseconds>t)&&this.canContinue));if(n.Stop(),!i&&this.canContinue||(null!==this._stateSnapshotAtLastNewline&&this.RestoreStateSnapshot(),this.canContinue||(this.state.callStack.canPopThread&&this.AddError("Thread available to pop, threads should always be flat by the end of evaluation?"),0!=this.state.generatedChoices.length||this.state.didSafeExit||null!=this._temporaryEvaluationContainer||(this.state.callStack.CanPop(H.Tunnel)?this.AddError("unexpectedly reached end of content. Do you need a '->->' to return from a tunnel?"):this.state.callStack.CanPop(H.Function)?this.AddError("unexpectedly reached end of content. Do you need a '~ return'?"):this.state.callStack.canPop?this.AddError("unexpectedly reached end of content for unknown reason. Please debug compiler!"):this.AddError("ran out of content. Do you need a '-> DONE' or '-> END'?"))),this.state.didSafeExit=!1,this._sawLookaheadUnsafeFunctionAfterNewline=!1,1==this._recursiveContinueCount&&(this._state.variablesState.batchObservingVariableChanges=!1),this._asyncContinueActive=!1,null!==this.onDidContinue&&this.onDidContinue()),this._recursiveContinueCount--,null!=this._profiler&&this._profiler.PostContinue(),this.state.hasError||this.state.hasWarning){if(null===this.onError){e=new j;throw e.Append("Ink had "),this.state.hasError&&(e.Append("".concat(this.state.currentErrors.length)),e.Append(1==this.state.currentErrors.length?" error":"errors"),this.state.hasWarning&&e.Append(" and ")),this.state.hasWarning&&(e.Append("".concat(this.state.currentWarnings.length)),e.Append(1==this.state.currentWarnings.length?" warning":"warnings"),this.state.hasWarning&&e.Append(" and ")),e.Append(". It is strongly suggested that you assign an error handler to story.onError. The first issue was: "),e.Append((this.state.hasError?this.state.currentErrors:this.state.currentWarnings)[0]),new G(e.toString())}if(this.state.hasError){var r,a=W(this.state.currentErrors);try{for(a.s();!(r=a.n()).done;){var s=r.value;this.onError(s,dt.Error)}}catch(s){a.e(s)}finally{a.f()}}if(this.state.hasWarning){var o,u=W(this.state.currentWarnings);try{for(u.s();!(o=u.n()).done;){var l=o.value;this.onError(l,dt.Warning)}}catch(s){u.e(s)}finally{u.f()}}this.ResetErrors()}}},{key:"ContinueSingleStep",value:function(){if(null!=this._profiler&&this._profiler.PreStep(),this.Step(),null!=this._profiler&&this._profiler.PostStep(),this.canContinue||this.state.callStack.elementIsEvaluateFromGame||this.TryFollowDefaultInvisibleChoice(),null!=this._profiler&&this._profiler.PreSnapshot(),!this.state.inStringEvaluation){if(null!==this._stateSnapshotAtLastNewline){if(null===this._stateSnapshotAtLastNewline.currentTags)return R("this._stateAtLastNewline.currentTags");if(null===this.state.currentTags)return R("this.state.currentTags");var t=this.CalculateNewlineOutputStateChange(this._stateSnapshotAtLastNewline.currentText,this.state.currentText,this._stateSnapshotAtLastNewline.currentTags.length,this.state.currentTags.length);if(t==f.OutputStateChange.ExtendedBeyondNewline||this._sawLookaheadUnsafeFunctionAfterNewline)return this.RestoreStateSnapshot(),!0;t==f.OutputStateChange.NewlineRemoved&&this.DiscardSnapshot()}this.state.outputStreamEndsInNewline&&(this.canContinue?null==this._stateSnapshotAtLastNewline&&this.StateSnapshot():this.DiscardSnapshot())}return null!=this._profiler&&this._profiler.PostSnapshot(),!1}},{key:"CalculateNewlineOutputStateChange",value:function(t,e,n,i){if(null===t)return R("prevText");if(null===e)return R("currText");var r=e.length>=t.length&&"\n"==e.charAt(t.length-1);if(n==i&&t.length==e.length&&r)return f.OutputStateChange.NoChange;if(!r)return f.OutputStateChange.NewlineRemoved;if(n<i)return f.OutputStateChange.ExtendedBeyondNewline;for(var a=t.length;a<e.length;a++){var s=e.charAt(a);if(" "!=s&&"\t"!=s)return f.OutputStateChange.ExtendedBeyondNewline}return f.OutputStateChange.NoChange}},{key:"ContinueMaximally",value:function(){this.IfAsyncWeCant("ContinueMaximally");for(var t=new j;this.canContinue;)t.Append(this.Continue());return t.toString()}},{key:"ContentAtPath",value:function(t){return this.mainContentContainer.ContentAtPath(t)}},{key:"KnotContainerWithName",value:function(t){t=this.mainContentContainer.namedContent.get(t);return t instanceof z?t:null}},{key:"PointerAtPath",value:function(t){if(0==t.length)return $.Null;var e=new $,n=t.length,i=null;return null===t.lastComponent?R("path.lastComponent"):(t.lastComponent.isIndex?(n=t.length-1,i=this.mainContentContainer.ContentAtPath(t,void 0,n),e.container=i.container,e.index=t.lastComponent.index):(i=this.mainContentContainer.ContentAtPath(t),e.container=i.container,e.index=-1),null==i.obj||i.obj==this.mainContentContainer&&0<n?this.Error("Failed to find content at path '"+t+"', and no approximation of it was possible."):i.approximate&&this.Warning("Failed to find content at path '"+t+"', so it was approximated to: '"+i.obj.path+"'."),e)}},{key:"StateSnapshot",value:function(){this._stateSnapshotAtLastNewline=this._state,this._state=this._state.CopyAndStartPatching()}},{key:"RestoreStateSnapshot",value:function(){null===this._stateSnapshotAtLastNewline&&R("_stateSnapshotAtLastNewline"),this._stateSnapshotAtLastNewline.RestoreAfterPatch(),this._state=this._stateSnapshotAtLastNewline,this._stateSnapshotAtLastNewline=null,this._asyncSaving||this._state.ApplyAnyPatch()}},{key:"DiscardSnapshot",value:function(){this._asyncSaving||this._state.ApplyAnyPatch(),this._stateSnapshotAtLastNewline=null}},{key:"CopyStateForBackgroundThreadSave",value:function(){if(this.IfAsyncWeCant("start saving on a background thread"),this._asyncSaving)throw new Error("Story is already in background saving mode, can't call CopyStateForBackgroundThreadSave again!");var t=this._state;return this._state=this._state.CopyAndStartPatching(),this._asyncSaving=!0,t}},{key:"BackgroundSaveComplete",value:function(){null===this._stateSnapshotAtLastNewline&&this._state.ApplyAnyPatch(),this._asyncSaving=!1}},{key:"Step",value:function(){var t=!0,e=this.state.currentPointer.copy();if(!e.isNull){for(var n=V(e.Resolve(),z);n&&(this.VisitContainer(n,!0),0!=n.content.length);)n=V((e=$.StartOf(n)).Resolve(),z);this.state.currentPointer=e.copy(),null!=this._profiler&&this._profiler.Step(this.state.callStack);var i,r=e.Resolve(),a=this.PerformLogicAndFlowControl(r);this.state.currentPointer.isNull||(a&&(t=!1),(a=V(r,Q))&&((i=this.ProcessChoice(a))&&this.state.generatedChoices.push(i),r=null,t=!1),(t=r instanceof z?!1:t)&&((i=V(r,I))&&-1==i.contextIndex&&(t=this.state.callStack.ContextForVariableNamed(i.variableName),r=new I(i.variableName,t)),this.state.inExpressionEvaluation?this.state.PushEvaluationStack(r):this.state.PushToOutputStream(r)),this.NextContent(),(r=V(r,X))&&r.commandType==X.CommandType.StartThread&&this.state.callStack.PushThread())}}},{key:"VisitContainer",value:function(t,e){t.countingAtStartOnly&&!e||(t.visitsShouldBeCounted&&this.state.IncrementVisitCountForContainer(t),t.turnIndexShouldBeCounted&&this.state.RecordTurnIndexVisitToContainer(t))}},{key:"VisitChangedContainersDueToDivert",value:function(){var t=this.state.previousPointer.copy(),e=this.state.currentPointer.copy();if(!e.isNull&&-1!=e.index){if(this._prevContainers.length=0,!t.isNull)for(var n=V(t.Resolve(),z)||V(t.container,z);n;)this._prevContainers.push(n),n=V(n.parent,z);var i=e.Resolve();if(null!=i)for(var r=V(i.parent,z),a=!0;r&&(this._prevContainers.indexOf(r)<0||r.countingAtStartOnly);){var s=0<r.content.length&&i==r.content[0]&&a;s||(a=!1),this.VisitContainer(r,s),r=V((i=r).parent,z)}}}},{key:"ProcessChoice",value:function(t){var e=!0;t.hasCondition&&(i=this.state.PopEvaluationStack(),this.IsTruthy(i)||(e=!1));var n="",i="";if(t.hasChoiceOnlyContent&&(i=L(this.state.PopEvaluationStack(),U).value||""),t.hasStartContent&&(n=L(this.state.PopEvaluationStack(),U).value||""),!(e=t.onceOnly&&0<this.state.VisitCountForContainer(t.choiceTarget)?!1:e))return null;e=new rt;return e.targetPath=t.pathOnChoice,e.sourcePath=t.path.toString(),e.isInvisibleDefault=t.isInvisibleDefault,e.threadAtGeneration=this.state.callStack.ForkThread(),e.text=(n+i).replace(/^[ \t]+|[ \t]+$/g,""),e}},{key:"IsTruthy",value:function(t){if(t instanceof M){t=t;return t instanceof q?(this.Error("Shouldn't use a divert target (to "+t.targetPath+") as a conditional value. Did you intend a function call 'likeThis()' or a read count check 'likeThis'? (no arrows)"),!1):t.isTruthy}return!1}},{key:"PerformLogicAndFlowControl",value:function(t){if(null==t)return!1;if(t instanceof Y){var e=t;if(e.isConditional){var n=this.state.PopEvaluationStack();if(!this.IsTruthy(n))return!0}if(e.hasVariableTarget){var i=e.variableDivertName,r=this.state.variablesState.GetVariableWithName(i);null==r?this.Error("Tried to divert using a target from a variable that could not be found ("+i+")"):r instanceof q||(n="Tried to divert to a target from a variable, but the variable ("+i+") didn't contain a divert target, it ",(i=V(r,J))instanceof J&&0==i.value?n+="was empty/null (the value 0).":n+="contained '"+r+"'.",this.Error(n));r=L(r,q);this.state.divertedPointer=this.PointerAtPath(r.targetPath)}else{if(e.isExternal)return this.CallExternalFunction(e.targetPathString,e.externalArgs),!0;this.state.divertedPointer=e.targetPointer.copy()}return e.pushesToStack&&this.state.callStack.Push(e.stackPushType,void 0,this.state.outputStream.length),this.state.divertedPointer.isNull&&!e.isExternal&&(e&&e.debugMetadata&&null!=e.debugMetadata.sourceName?this.Error("Divert target doesn't exist: "+e.debugMetadata.sourceName):this.Error("Divert resolution failed: "+e)),!0}if(t instanceof X){var a=t;switch(a.commandType){case X.CommandType.EvalStart:this.Assert(!1===this.state.inExpressionEvaluation,"Already in expression evaluation?"),this.state.inExpressionEvaluation=!0;break;case X.CommandType.EvalEnd:this.Assert(!0===this.state.inExpressionEvaluation,"Not in expression evaluation mode"),this.state.inExpressionEvaluation=!1;break;case X.CommandType.EvalOutput:0<this.state.evaluationStack.length&&((o=this.state.PopEvaluationStack())instanceof et||(u=new U(o.toString()),this.state.PushToOutputStream(u)));break;case X.CommandType.NoOp:break;case X.CommandType.Duplicate:this.state.PushEvaluationStack(this.state.PeekEvaluationStack());break;case X.CommandType.PopEvaluatedValue:this.state.PopEvaluationStack();break;case X.CommandType.PopFunction:case X.CommandType.PopTunnel:var s,o=a.commandType==X.CommandType.PopFunction?H.Function:H.Tunnel,u=null;if(o!=H.Tunnel||null===(u=V(s=this.state.PopEvaluationStack(),q))&&this.Assert(s instanceof et,"Expected void if ->-> doesn't override target"),this.state.TryExitFunctionEvaluationFromGame())break;this.state.callStack.currentElement.type==o&&this.state.callStack.canPop?(this.state.PopCallStack(),u&&(this.state.divertedPointer=this.PointerAtPath(u.targetPath))):((s=new Map).set(H.Function,"function return statement (~ return)"),s.set(H.Tunnel,"tunnel onwards statement (->->)"),u=s.get(this.state.callStack.currentElement.type),this.state.callStack.canPop||(u="end of flow (-> END or choice)"),u="Found "+s.get(o)+", when expected "+u,this.Error(u));break;case X.CommandType.BeginString:this.state.PushToOutputStream(a),this.Assert(!0===this.state.inExpressionEvaluation,"Expected to be in an expression when evaluating a string"),this.state.inExpressionEvaluation=!1;break;case X.CommandType.EndString:for(var l=[],h=0,c=this.state.outputStream.length-1;0<=c;--c){var f=this.state.outputStream[c];h++;var v=V(f,X);if(v&&v.commandType==X.CommandType.BeginString)break;f instanceof U&&l.push(f)}this.state.PopFromOutputStream(h);var d,l=l.reverse(),p=new j,y=W(l);try{for(y.s();!(d=y.n()).done;){var m=d.value;p.Append(m.toString())}}catch(t){y.e(t)}finally{y.f()}this.state.inExpressionEvaluation=!0,this.state.PushEvaluationStack(new U(p.toString()));break;case X.CommandType.ChoiceCount:var g=this.state.generatedChoices.length;this.state.PushEvaluationStack(new J(g));break;case X.CommandType.Turns:this.state.PushEvaluationStack(new J(this.state.currentTurnIndex+1));break;case X.CommandType.TurnsSince:case X.CommandType.ReadCount:g=this.state.PopEvaluationStack();if(!(g instanceof q)){this.Error("TURNS_SINCE / READ_COUNT expected a divert target (knot, stitch, label name), but saw "+g+(g instanceof J?". Did you accidentally pass a read count ('knot_name') instead of a target ('-> knot_name')?":""));break}var S=L(g,q),g=V(this.ContentAtPath(S.targetPath).correctObj,z);null!=g?C=a.commandType==X.CommandType.TurnsSince?this.state.TurnsSinceForContainer(g):this.state.VisitCountForContainer(g):(C=a.commandType==X.CommandType.TurnsSince?-1:0,this.Warning("Failed to find container for "+a.toString()+" lookup at "+S.targetPath.toString())),this.state.PushEvaluationStack(new J(C));break;case X.CommandType.Random:var k=V(this.state.PopEvaluationStack(),J),S=V(this.state.PopEvaluationStack(),J);if(null==S||S instanceof J==!1)return this.Error("Invalid value for minimum parameter of RANDOM(min, max)");if(null==k||S instanceof J==!1)return this.Error("Invalid value for maximum parameter of RANDOM(min, max)");if(null===k.value)return R("maxInt.value");if(null===S.value)return R("minInt.value");var C=k.value-S.value+1;(!isFinite(C)||C>Number.MAX_SAFE_INTEGER)&&(C=Number.MAX_SAFE_INTEGER,this.Error("RANDOM was called with a range that exceeds the size that ink numbers can use.")),C<=0&&this.Error("RANDOM was called with minimum as "+S.value+" and maximum as "+k.value+". The maximum must be larger");k=this.state.storySeed+this.state.previousRandom,k=new ct(k).next(),S=k%C+S.value;this.state.PushEvaluationStack(new J(S)),this.state.previousRandom=k;break;case X.CommandType.SeedRandom:var b=V(this.state.PopEvaluationStack(),J);if(null==b||b instanceof J==!1)return this.Error("Invalid value passed to SEED_RANDOM");if(null===b.value)return R("minInt.value");this.state.storySeed=b.value,this.state.previousRandom=0,this.state.PushEvaluationStack(new et);break;case X.CommandType.VisitIndex:var _=this.state.VisitCountForContainer(this.state.currentPointer.container)-1;this.state.PushEvaluationStack(new J(_));break;case X.CommandType.SequenceShuffleIndex:var w=this.NextSequenceShuffleIndex();this.state.PushEvaluationStack(new J(w));break;case X.CommandType.StartThread:break;case X.CommandType.Done:this.state.callStack.canPopThread?this.state.callStack.PopThread():(this.state.didSafeExit=!0,this.state.currentPointer=$.Null);break;case X.CommandType.End:this.state.ForceEnd();break;case X.CommandType.ListFromInt:k=V(this.state.PopEvaluationStack(),J),b=L(this.state.PopEvaluationStack(),U);if(null===k)throw new G("Passed non-integer when creating a list element from a numerical value.");_=null;if(null===this.listDefinitions)return R("this.listDefinitions");w=this.listDefinitions.TryListGetDefinition(b.value,null);if(!w.exists)throw new G("Failed to find LIST called "+b.value);if(null===k.value)return R("minInt.value");w=w.result.TryGetItemWithValue(k.value,D.Null);null==(_=w.exists?new K(w.result,k.value):_)&&(_=new K),this.state.PushEvaluationStack(_);break;case X.CommandType.ListRange:var T=V(this.state.PopEvaluationStack(),M),E=V(this.state.PopEvaluationStack(),M),P=V(this.state.PopEvaluationStack(),K);if(null===P||null===E||null===T)throw new G("Expected list, minimum and maximum for LIST_RANGE");if(null===P.value)return R("targetList.value");P=P.value.ListWithSubRange(E.valueObject,T.valueObject);this.state.PushEvaluationStack(new K(P));break;case X.CommandType.ListRandom:E=this.state.PopEvaluationStack();if(null===E)throw new G("Expected list for LIST_RANDOM");T=E.value,P=null;if(null===T)throw R("list");if(0==T.Count)P=new B;else{for(var E=this.state.storySeed+this.state.previousRandom,E=new ct(E).next(),O=E%T.Count,N=T.entries(),A=0;A<=O-1;A++)N.next();T=N.next().value,T={Key:D.fromSerializedKey(T[0]),Value:T[1]};if(null===T.Key.originName)return R("randomItem.Key.originName");(P=new B(T.Key.originName,this)).Add(T.Key,T.Value),this.state.previousRandom=E}this.state.PushEvaluationStack(new K(P));break;default:this.Error("unhandled ControlCommand: "+a)}return!0}if(t instanceof tt){var I=t,x=this.state.PopEvaluationStack();return this.state.variablesState.Assign(I,x),!0}if(t instanceof Z){var I=t,F=null;return null!=I.pathForCount?(x=I.containerForCount,x=this.state.VisitCountForContainer(x),F=new J(x)):null==(F=this.state.variablesState.GetVariableWithName(I.name))&&(this.Warning("Variable not found: '"+I.name+"'. Using default value of 0 (false). This can happen with temporary variables if the declaration hasn't yet been hit. Globals are always given a default value on load if a value doesn't exist in the save state."),F=new J(0)),this.state.PushEvaluationStack(F),!0}if(t instanceof nt){F=t,t=this.state.PopEvaluationStack(F.numberOfParameters),t=F.Call(t);return this.state.PushEvaluationStack(t),!0}return!1}},{key:"ChoosePathString",value:function(t){var e=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:[];if(this.IfAsyncWeCant("call ChoosePathString right now"),null!==this.onChoosePathString&&this.onChoosePathString(t,n),e)this.ResetCallstack();else if(this.state.callStack.currentElement.type==H.Function){var i="",e=this.state.callStack.currentElement.currentPointer.container;throw null!=e&&(i="("+e.path.toString()+") "),new Error("Story was running a function "+i+"when you called ChoosePathString("+t+") - this is almost certainly not not what you want! Full stack trace: \n"+this.state.callStack.callStackTrace)}this.state.PassArgumentsToEvaluationStack(n),this.ChoosePath(new C(t))}},{key:"IfAsyncWeCant",value:function(t){if(this._asyncContinueActive)throw new Error("Can't "+t+". Story is in the middle of a ContinueAsync(). Make more ContinueAsync() calls or a single Continue() call beforehand.")}},{key:"ChoosePath",value:function(t){this.state.SetChosenPath(t,!(1<arguments.length&&void 0!==arguments[1])||arguments[1]),this.VisitChangedContainersDueToDivert()}},{key:"ChooseChoiceIndex",value:function(t){var e=this.currentChoices;this.Assert(0<=t&&t<e.length,"choice out of range");t=e[t];return null!==this.onMakeChoice&&this.onMakeChoice(t),null===t.threadAtGeneration?R("choiceToChoose.threadAtGeneration"):null===t.targetPath?R("choiceToChoose.targetPath"):(this.state.callStack.currentThread=t.threadAtGeneration,void this.ChoosePath(t.targetPath))}},{key:"HasFunction",value:function(t){try{return null!=this.KnotContainerWithName(t)}catch(t){return!1}}},{key:"EvaluateFunction",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[],n=2<arguments.length&&void 0!==arguments[2]&&arguments[2];if(null!==this.onEvaluateFunction&&this.onEvaluateFunction(t,e),this.IfAsyncWeCant("evaluate a function"),null==t)throw new Error("Function is null");if(""==t||""==t.trim())throw new Error("Function is empty or white space.");var i=this.KnotContainerWithName(t);if(null==i)throw new Error("Function doesn't exist: '"+t+"'");var r=[];r.push.apply(r,p(this.state.outputStream)),this._state.ResetOutput(),this.state.StartFunctionEvaluationFromGame(i,e);for(var a=new j;this.canContinue;)a.Append(this.Continue());i=a.toString();this._state.ResetOutput(r);r=this.state.CompleteFunctionEvaluationFromGame();return null!=this.onCompleteEvaluateFunction&&this.onCompleteEvaluateFunction(t,e,i,r),n?{returned:r,output:i}:r}},{key:"EvaluateExpression",value:function(t){var e=this.state.callStack.elements.length;this.state.callStack.Push(H.Tunnel),this._temporaryEvaluationContainer=t,this.state.GoToStart();t=this.state.evaluationStack.length;return this.Continue(),this._temporaryEvaluationContainer=null,this.state.callStack.elements.length>e&&this.state.PopCallStack(),t<this.state.evaluationStack.length?this.state.PopEvaluationStack():null}},{key:"CallExternalFunction",value:function(t,e){if(null===t)return R("funcName");var n,i=this._externals.get(t),r=void 0!==i;if(!r||i.lookAheadSafe||null===this._stateSnapshotAtLastNewline){if(!r){if(this.allowExternalFunctionFallbacks)return n=this.KnotContainerWithName(t),this.Assert(null!==n,"Trying to call EXTERNAL function '"+t+"' which has not been bound, and fallback ink function could not be found."),this.state.callStack.Push(H.Function,void 0,this.state.outputStream.length),void(this.state.divertedPointer=$.StartOf(n));this.Assert(!1,"Trying to call EXTERNAL function '"+t+"' which has not been bound (and ink fallbacks disabled).")}for(var a=[],s=0;s<e;++s){var o=L(this.state.PopEvaluationStack(),M).valueObject;a.push(o)}a.reverse();t=i.function(a),i=null;null!=t?(i=M.Create(t),this.Assert(null!==i,"Could not create ink value from returned object of type "+g(t))):i=new et,this.state.PushEvaluationStack(i)}else this._sawLookaheadUnsafeFunctionAfterNewline=!0}},{key:"BindExternalFunctionGeneral",value:function(t,e,n){this.IfAsyncWeCant("bind an external function"),this.Assert(!this._externals.has(t),"Function '"+t+"' has already been bound."),this._externals.set(t,{function:e,lookAheadSafe:n})}},{key:"TryCoerce",value:function(t){return t}},{key:"BindExternalFunction",value:function(t,r,e){var a=this;this.Assert(null!=r,"Can't bind a null function"),this.BindExternalFunctionGeneral(t,function(t){a.Assert(t.length>=r.length,"External function expected "+r.length+" arguments");for(var e=[],n=0,i=t.length;n<i;n++)e[n]=a.TryCoerce(t[n]);return r.apply(null,e)},e)}},{key:"UnbindExternalFunction",value:function(t){this.IfAsyncWeCant("unbind an external a function"),this.Assert(this._externals.has(t),"Function '"+t+"' has not been bound."),this._externals.delete(t)}},{key:"ValidateExternalBindings",value:function(){var t,e=null,n=null,i=arguments[1]||new Set;if(arguments[0]instanceof z&&(e=arguments[0]),arguments[0]instanceof T&&(n=arguments[0]),null===e&&null===n)this.ValidateExternalBindings(this._mainContentContainer,i),this._hasValidatedExternals=!0,0==i.size?this._hasValidatedExternals=!0:(t="Error: Missing function binding for external",t+=1<i.size?"s":"",t+=": '",t+=Array.from(i).join("', '"),t+="' ",t+=this.allowExternalFunctionFallbacks?", and no fallback ink function found.":" (ink fallbacks disabled)",this.Error(t));else if(null!=e){var r,a=W(e.content);try{for(a.s();!(r=a.n()).done;){var s=r.value;null!=s&&s.hasValidName||this.ValidateExternalBindings(s,i)}}catch(t){a.e(t)}finally{a.f()}var o,u=W(e.namedContent);try{for(u.s();!(o=u.n()).done;){var l=S(o.value,2)[1];this.ValidateExternalBindings(V(l,T),i)}}catch(t){u.e(t)}finally{u.f()}}else if(null!=n){n=V(n,Y);if(n&&n.isExternal){n=n.targetPathString;if(null===n)return R("name");this._externals.has(n)||this.allowExternalFunctionFallbacks&&this.mainContentContainer.namedContent.has(n)||i.add(n)}}}},{key:"ObserveVariable",value:function(t,e){if(this.IfAsyncWeCant("observe a new variable"),null===this._variableObservers&&(this._variableObservers=new Map),!this.state.variablesState.GlobalVariableExistsWithName(t))throw new Error("Cannot observe variable '"+t+"' because it wasn't declared in the ink story.");this._variableObservers.has(t)?this._variableObservers.get(t).push(e):this._variableObservers.set(t,[e])}},{key:"ObserveVariables",value:function(t,e){for(var n=0,i=t.length;n<i;n++)this.ObserveVariable(t[n],e[n])}},{key:"RemoveVariableObserver",value:function(){var t,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null,n=1<arguments.length?arguments[1]:void 0;if(this.IfAsyncWeCant("remove a variable observer"),null!==this._variableObservers)if(null!=n)this._variableObservers.has(n)&&(null!==e&&null!==(t=this._variableObservers.get(n))?t.splice(t.indexOf(e),1):this._variableObservers.delete(n));else if(null!=e){var i,r=W(this._variableObservers.keys());try{for(r.s();!(i=r.n()).done;){var a=i.value,s=this._variableObservers.get(a);null!==s?s.splice(s.indexOf(e),1):this._variableObservers.delete(n)}}catch(t){r.e(t)}finally{r.f()}}}},{key:"VariableStateDidChangeEvent",value:function(t,e){if(null!==this._variableObservers){var n=this._variableObservers.get(t);if(void 0!==n){if(!(e instanceof M))throw new Error("Tried to get the value of a variable that isn't a standard type");var i,r=L(e,M),a=W(n);try{for(a.s();!(i=a.n()).done;)(0,i.value)(t,r.valueObject)}catch(t){a.e(t)}finally{a.f()}}}}},{key:"globalTags",get:function(){return this.TagsAtStartOfFlowContainerWithPathString("")}},{key:"TagsForContentAtPath",value:function(t){return this.TagsAtStartOfFlowContainerWithPathString(t)}},{key:"TagsAtStartOfFlowContainerWithPathString",value:function(t){var t=new C(t),e=this.ContentAtPath(t).container;if(null===e)return R("flowContainer");for(;;){var n=e.content[0];if(!(n instanceof z))break;e=n}var i,r=null,a=W(e.content);try{for(a.s();!(i=a.n()).done;){var s=V(i.value,it);if(!s)break;(r=null==r?[]:r).push(s.text)}}catch(t){a.e(t)}finally{a.f()}return r}},{key:"BuildStringOfHierarchy",value:function(){var t=new j;return this.mainContentContainer.BuildStringOfHierarchy(t,0,this.state.currentPointer.Resolve()),t.toString()}},{key:"BuildStringOfContainer",value:function(t){var e=new j;return t.BuildStringOfHierarchy(e,0,this.state.currentPointer.Resolve()),e.toString()}},{key:"NextContent",value:function(){var t;this.state.previousPointer=this.state.currentPointer.copy(),(this.state.divertedPointer.isNull||(this.state.currentPointer=this.state.divertedPointer.copy(),this.state.divertedPointer=$.Null,this.VisitChangedContainersDueToDivert(),this.state.currentPointer.isNull))&&(this.IncrementContentPointer()||(t=!1,this.state.callStack.CanPop(H.Function)?(this.state.PopCallStack(H.Function),this.state.inExpressionEvaluation&&this.state.PushEvaluationStack(new et),t=!0):this.state.callStack.canPopThread?(this.state.callStack.PopThread(),t=!0):this.state.TryExitFunctionEvaluationFromGame(),t&&!this.state.currentPointer.isNull&&this.NextContent()))}},{key:"IncrementContentPointer",value:function(){var t=!0,e=this.state.callStack.currentElement.currentPointer.copy();if(e.index++,null===e.container)return R("pointer.container");for(;e.index>=e.container.content.length;){var t=!1,n=V(e.container.parent,z);if(n instanceof z==!1)break;var i=n.content.indexOf(e.container);if(-1==i)break;if((e=new $(n,i)).index++,t=!0,null===e.container)return R("pointer.container")}return t||(e=$.Null),this.state.callStack.currentElement.currentPointer=e.copy(),t}},{key:"TryFollowDefaultInvisibleChoice",value:function(){var t=this._state.currentChoices,e=t.filter(function(t){return t.isInvisibleDefault});if(0==e.length||t.length>e.length)return!1;e=e[0];return null===e.targetPath?R("choice.targetPath"):null===e.threadAtGeneration?R("choice.threadAtGeneration"):(this.state.callStack.currentThread=e.threadAtGeneration,null!==this._stateSnapshotAtLastNewline&&(this.state.callStack.currentThread=this.state.callStack.ForkThread()),this.ChoosePath(e.targetPath,!1),!0)}},{key:"NextSequenceShuffleIndex",value:function(){var t=V(this.state.PopEvaluationStack(),J);if(!(t instanceof J))return this.Error("expected number of elements in sequence for shuffle index"),0;var e=this.state.currentPointer.container;if(null===e)return R("seqContainer");if(null===t.value)return R("numElementsIntVal.value");var n=t.value,i=L(this.state.PopEvaluationStack(),J).value;if(null===i)return R("seqCount");for(var t=i/n,r=i%n,a=e.path.toString(),s=0,o=0,u=a.length;o<u;o++)s+=a.charCodeAt(o)||0;for(var t=s+t+this.state.storySeed,l=new ct(Math.floor(t)),h=[],c=0;c<n;++c)h.push(c);for(var f=0;f<=r;++f){var v=l.next()%h.length,d=h[v];if(h.splice(v,1),f==r)return d}throw new Error("Should never reach here")}},{key:"Error",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]&&arguments[1],t=new G(t);throw t.useEndLineNumber=e,t}},{key:"Warning",value:function(t){this.AddError(t,!0)}},{key:"AddError",value:function(t){var e,n=1<arguments.length&&void 0!==arguments[1]&&arguments[1],i=this.currentDebugMetadata,r=n?"WARNING":"ERROR";t=null!=i?(e=2<arguments.length&&void 0!==arguments[2]&&arguments[2]?i.endLineNumber:i.startLineNumber,"RUNTIME "+r+": '"+i.fileName+"' line "+e+": "+t):this.state.currentPointer.isNull?"RUNTIME "+r+": "+t:"RUNTIME "+r+": ("+this.state.currentPointer+"): "+t,this.state.AddError(t,n),n||this.state.ForceEnd()}},{key:"Assert",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;if(0==t)throw null==e&&(e="Story assert"),new Error(e+" "+this.currentDebugMetadata)}},{key:"currentDebugMetadata",get:function(){var t=this.state.currentPointer;if(!t.isNull&&null!==t.Resolve()&&null!==(n=t.Resolve().debugMetadata))return n;for(var e=this.state.callStack.elements.length-1;0<=e;--e)if(!(t=this.state.callStack.elements[e].currentPointer).isNull&&null!==t.Resolve()&&null!==(n=t.Resolve().debugMetadata))return n;for(var n,i=this.state.outputStream.length-1;0<=i;--i)if(null!==(n=this.state.outputStream[i].debugMetadata))return n;return null}},{key:"mainContentContainer",get:function(){return this._temporaryEvaluationContainer||this._mainContentContainer}}]),f}(),a.Story.inkVersionCurrent=20,(pt=(pt=a.Story||(a.Story={})).OutputStateChange||(pt.OutputStateChange={}))[pt.NoChange=0]="NoChange",pt[pt.ExtendedBeyondNewline=1]="ExtendedBeyondNewline",pt[pt.NewlineRemoved=2]="NewlineRemoved",a.InkList=B,Object.defineProperty(a,"__esModule",{value:!0})});
//# sourceMappingURL=ink.js.map
